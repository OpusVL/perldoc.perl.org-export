      
      
      
      

      <!DOCTYPE html>
      <html lang="en">

      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="perlcall - perldoc.perl.org">
        <link rel="icon" href="/public/img/favicon.ico">
        <title>perlcall - perldoc.perl.org</title>
        <link href="/public/css/main.min.css" rel="stylesheet">
        <link rel="canonical" href="/perlcall.html">
        <link
          href='https://fonts.googleapis.com/css?family=Lato:400,100,300,700,900'
          rel='stylesheet' type='text/css'>
        <script>
          window.ga = window.ga || function () {
            (ga.q = ga.q || []).push(arguments)
          };
          ga.l = +new Date;
          ga('create', 'UA-1892152-2', 'auto'); // JJ's account
          ga('create', 'UA-50555-3', 'auto', 'perlOrg'); // perl.org account
          ga('require', 'outboundLinkTracker', {
            events: ['click', 'auxclick', 'contextmenu'],
          });
          ga('require', 'maxScrollTracker');
          ga('send', 'pageview');
          ga('perlOrg.send', 'pageview');
        </script>
        <script async src="https://www.google-analytics.com/analytics.js">
        </script>
        <script async src="/public/js/tracking.min.js"></script>
      </head>

      <body class="body container-fluid ">
        <div class="wrapper">

          <nav
    class="navbar navbar-dark bg-primary bg-perl fixed-top justify-content-between navbar-expand-lg">
    <a href="#content" class="skippy sr-only sr-only-focusable">
        <span class=' skippy-text'>Skip to main content</span>
    </a>
    <a class="navbar-brand" href="/">
        <img class="logo" src="/public/img/logo_perl_doc.svg"
            alt="Perl Documentation Logo" />
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
        data-target="#navbar" aria-controls="navbar" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div id="navbar" class="collapse navbar-collapse ">
        <ul class="navbar-nav ml-auto navbar-right">
            <form class="nav-item dropdown search-wrapper">
                <input type="text" id='searchinput' aria-describedby='navbarDropdown5'
                    placeholder="Type query" class='search-input-field' value=''>

                <button href="#" data-toggle='dropdown' type="button"
                    aria-haspopup="true" aria-expanded='false' id="navbarDropdown5"
                    class="nav-link dropdown-toggle search-link">
                    <object tabindex='-1' focusable="false" class='search-icon'
                        data="/public/img/search.svg" type="image/svg+xml"
                        name='search icon'>search
                        icon</object>
                </button>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown5"
                    id='search-results'>
                    <p class='dropdown-item major-version'>
                        No results
                    </p>
                </div>
            </form>
            <li class="nav-item dropdown">
                <a id="navbarDropdown" href="#" class="nav-link dropdown-toggle"
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Perl versions</a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                    
                        <p class='dropdown-item major-version'>
                            5.32
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.32.0/">5.32.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.30
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.30.3/">5.30.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.2/">5.30.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.1/">5.30.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.30.0/">5.30.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.28
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.28.3/">5.28.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.2/">5.28.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.1/">5.28.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.28.0/">5.28.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.26
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.26.3/">5.26.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.2/">5.26.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.1/">5.26.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.26.0/">5.26.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.24
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.24.4/">5.24.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.3/">5.24.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.2/">5.24.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.1/">5.24.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.24.0/">5.24.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.22
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.22.4/">5.22.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.3/">5.22.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.2/">5.22.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.1/">5.22.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.22.0/">5.22.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.20
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.20.3/">5.20.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.2/">5.20.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.1/">5.20.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.20.0/">5.20.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.18
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.18.4/">5.18.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.3/">5.18.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.2/">5.18.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.1/">5.18.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.18.0/">5.18.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.16
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.16.3/">5.16.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.2/">5.16.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.1/">5.16.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.16.0/">5.16.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.14
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.14.4/">5.14.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.3/">5.14.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.2/">5.14.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.1/">5.14.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.14.0/">5.14.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.12
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.12.5/">5.12.5</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.4/">5.12.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.3/">5.12.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.2/">5.12.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.1/">5.12.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.12.0/">5.12.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.10
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.10.1/">5.10.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.10.0/">5.10.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.8
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.8.9/">5.8.9</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.8/">5.8.8</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.7/">5.8.7</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.6/">5.8.6</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.5/">5.8.5</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.4/">5.8.4</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.3/">5.8.3</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.2/">5.8.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.1/">5.8.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.8.0/">5.8.0</a>
                        
                        
                        <div class="dropdown-divider"></div>
                        
                    
                        <p class='dropdown-item major-version'>
                            5.6
                        </p>
                        
                        <a class='dropdown-item minor-version' href="/5.6.2/">5.6.2</a>
                        
                        <a class='dropdown-item minor-version' href="/5.6.1/">5.6.1</a>
                        
                        <a class='dropdown-item minor-version' href="/5.6.0/">5.6.0</a>
                        
                        
                    
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown1" href="#" class="dropdown-toggle nav-link"
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Manuals</a>
                <div class="dropdown-menu" aria-labelledby="navbarDropdown1">
                    <a class="dropdown-item"
                        href="/5.14.3/index-overview.html">Overview</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-tutorials.html">Tutorials</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-faq.html">FAQs</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-history.html">Changes</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-licence.html">License</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-language.html">Language</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-functions.html">Functions</a>
                    <a class="dropdown-item"
                        href="/5.14.3/perlop.html">Operators</a>
                    <a class="dropdown-item"
                        href="/5.14.3/perlvar.html">Variables</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-pragmas.html">Pragmas</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-utilities.html">Utilities</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-internals.html">Internals</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-platforms.html">Platforms</a>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown3" href="#" class="nav-link dropdown-toggle "
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Modules</a>
                <div aria-labelledby="navbarDropdown3"
                    class="dropdown-menu letters-wrap">
                    <!--<a class="dropdown-item"
                        href="/5.14.3/index-modules.html">A-Z</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-modules-by-cat.html">By
                        Category</a>-->
                    <div class="dropdown-divider"></div>
                    <div class="letter-container">
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-A.html">A</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-B.html">B</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-C.html">C</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-D.html">D</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-E.html">E</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-F.html">F</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-G.html">G</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-H.html">H</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-I.html">I</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-J.html">J</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-K.html">K</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-L.html">L</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-M.html">M</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-N.html">N</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-O.html">O</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-P.html">P</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-Q.html">Q</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-R.html">R</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-S.html">S</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-T.html">T</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-U.html">U</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-V.html">V</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-W.html">W</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-X.html">X</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-Y.html">Y</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-modules-Z.html">Z</a>
                    </div>
                </div>
            </li>
            <li class="nav-item dropdown">
                <a id="navbarDropdown4" href="#" class="nav-link dropdown-toggle "
                    data-toggle="dropdown" role="button" aria-haspopup="true"
                    aria-expanded="false">Functions</a>
                <div aria-labelledby="navbarDropdown4"
                    class="dropdown-menu letters-wrap">
                    <a class="dropdown-item"
                        href="/5.14.3/index-functions.html">A-Z</a>
                    <a class="dropdown-item"
                        href="/5.14.3/index-functions-by-cat.html">By
                        Category</a>
                    <div class="dropdown-divider"></div>
                    <div class="letter-container">
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#A">A</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#B">B</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#C">C</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#D">D</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#E">E</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#F">F</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#G">G</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#H">H</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#I">I</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#J">J</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#K">K</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#L">L</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#M">M</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#N">N</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#O">O</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#P">P</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#Q">Q</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#R">R</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#S">S</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#T">T</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#U">U</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#V">V</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#W">W</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#X">X</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#Y">Y</a>
                        <a class="dropdown-item letters"
                            href="/5.14.3/index-functions.html#Z">Z</a>
                    </div>
                </div>
            </li>
        </ul>
    </div>
    <!--/.nav-collapse -->
</nav>


          <main class="row main-content pb-5 pt-5" id='content'>
            <div class="col-sm-10 offset-sm-1 col-xl-8 offset-xl-2">
              <div class="row">
                <div class="col-sm-12">
                  <div id="breadcrumbs">
                      
    <a href="index.html">Home</a>&nbsp; &gt;
    
      
        <a href="index-internals.html">Internals and C language interface</a> &gt;
      
    
    perlcall
  

                  </div>
                </div>
              </div>
              <div class="row">
                <article class="col-sm-12 content">
                  <div class="documentation-wrapper">
                    <div id="perl_version">
                      <h7 class='page-title'> Perl 5 version 14.3
                        documentation</h7>
                    </div>
                    <h1>perlcall</h1>


  <!--    -->
<ul><li><a href="#NAME">NAME</a></li><li><a href="#DESCRIPTION">DESCRIPTION</a></li><li><a href="#THE-CALL_-FUNCTIONS">THE CALL_ FUNCTIONS</a></li><li><a href="#FLAG-VALUES">FLAG VALUES</a></li><ul><li><a href="#G_VOID">G_VOID</a></li><li><a href="#G_SCALAR">G_SCALAR</a></li><li><a href="#G_ARRAY">G_ARRAY</a></li><li><a href="#G_DISCARD">G_DISCARD</a></li><li><a href="#G_NOARGS">G_NOARGS</a></li><li><a href="#G_EVAL">G_EVAL</a></li><li><a href="#G_KEEPERR">G_KEEPERR</a></li><li><a href="#Determining-the-Context">Determining the Context</a></li></ul><li><a href="#EXAMPLES">EXAMPLES</a></li><ul><li><a href="#No-Parameters%2c-Nothing-Returned">No Parameters, Nothing Returned</a></li><li><a href="#Passing-Parameters">Passing Parameters</a></li><li><a href="#Returning-a-Scalar">Returning a Scalar</a></li><li><a href="#Returning-a-List-of-Values">Returning a List of Values</a></li><li><a href="#Returning-a-List-in-a-Scalar-Context">Returning a List in a Scalar Context</a></li><li><a href="#Returning-Data-from-Perl-via-the-Parameter-List">Returning Data from Perl via the Parameter List</a></li><li><a href="#Using-G_EVAL">Using G_EVAL</a></li><li><a href="#Using-G_KEEPERR">Using G_KEEPERR</a></li><li><a href="#Using-call_sv">Using call_sv</a></li><li><a href="#Using-call_argv">Using call_argv</a></li><li><a href="#Using-call_method">Using call_method</a></li><li><a href="#Using-GIMME_V">Using GIMME_V</a></li><li><a href="#Using-Perl-to-Dispose-of-Temporaries">Using Perl to Dispose of Temporaries</a></li><li><a href="#Strategies-for-Storing-Callback-Context-Information">Strategies for Storing Callback Context Information</a></li><li><a href="#Alternate-Stack-Manipulation">Alternate Stack Manipulation</a></li><li><a href="#Creating-and-Calling-an-Anonymous-Subroutine-in-C">Creating and Calling an Anonymous Subroutine in C</a></li></ul><li><a href="#LIGHTWEIGHT-CALLBACKS">LIGHTWEIGHT CALLBACKS</a></li><li><a href="#SEE-ALSO">SEE ALSO</a></li><li><a href="#AUTHOR">AUTHOR</a></li><li><a href="#DATE">DATE</a></li></ul><a class='view-head1' id="NAME"></a><h2 class='h2' >NAME</h2>
<p>perlcall - Perl calling conventions from C</p>
<a class='view-head1' id="DESCRIPTION"></a><h2 class='h2' >DESCRIPTION</h2>
<p>The purpose of this document is to show you how to call Perl subroutines
directly from C, i.e., how to write <i>callbacks</i>.</p>
<p>Apart from discussing the C interface provided by Perl for writing
callbacks the document uses a series of examples to show how the
interface actually works in practice.  In addition some techniques for
coding callbacks are covered.</p>
<p>Examples where callbacks are necessary include</p>
<ul>
<li><a class='view-title' id="*-An-Error-Handler"></a><strong>An Error Handler</strong>
<p>You have created an XSUB interface to an application's C API.</p>
<p>A fairly common feature in applications is to allow you to define a C
function that will be called whenever something nasty occurs. What we
would like is to be able to specify a Perl subroutine that will be
called instead.</p>
</li>
<li><a class='view-title' id="*-An-Event-Driven-Program"></a><strong>An Event-Driven Program</strong>
<p>The classic example of where callbacks are used is when writing an
event driven program, such as for an X windows application.  In this case
you register functions to be called whenever specific events occur,
e.g., a mouse button is pressed, the cursor moves into a window or a
menu item is selected.</p>
</li>
</ul>
<p>Although the techniques described here are applicable when embedding
Perl in a C program, this is not the primary goal of this document.
There are other details that must be considered and are specific to
embedding Perl. For details on embedding Perl in C refer to
<a href="perlembed.html">perlembed</a>.</p>
<p>Before you launch yourself head first into the rest of this document,
it would be a good idea to have read the following two documents--<a href="perlxs.html">perlxs</a>
and <a href="perlguts.html">perlguts</a>.</p>
<a class='view-head1' id="THE-CALL_-FUNCTIONS"></a><h2 class='h2' >THE CALL_ FUNCTIONS</h2>
<p>Although this stuff is easier to explain using examples, you first need
be aware of a few important definitions.</p>
<p>Perl has a number of C functions that allow you to call Perl
subroutines.  They are</p>
<pre class="verbatim"><ol><li>    <span class="w">I32</span> <span class="i">call_sv</span><span class="s">(</span><span class="w">SV</span>* <span class="w">sv</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">flags</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">I32</span> <span class="i">call_pv</span><span class="s">(</span><span class="w">char</span> *<span class="w">subname</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">flags</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">I32</span> <span class="i">call_method</span><span class="s">(</span><span class="w">char</span> *<span class="w">methname</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">flags</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">I32</span> <span class="i">call_argv</span><span class="s">(</span><span class="w">char</span> *<span class="w">subname</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">flags</span><span class="cm">,</span> <span class="w">register</span> <span class="w">char</span> **<span class="w">argv</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>The key function is <i>call_sv</i>.  All the other functions are
fairly simple wrappers which make it easier to call Perl subroutines in
special cases. At the end of the day they will all call <i>call_sv</i>
to invoke the Perl subroutine.</p>
<p>All the <i>call_*</i> functions have a <code class="inline"><span class="w">flags</span></code>
 parameter which is
used to pass a bit mask of options to Perl.  This bit mask operates
identically for each of the functions.  The settings available in the
bit mask are discussed in <a href="#FLAG-VALUES">FLAG VALUES</a>.</p>
<p>Each of the functions will now be discussed in turn.</p>
<ul>
<li><a class='view-title' id="call_sv"></a><strong>call_sv</strong>
<p><i>call_sv</i> takes two parameters. The first, <code class="inline"><span class="w">sv</span></code>
, is an SV*.
This allows you to specify the Perl subroutine to be called either as a
C string (which has first been converted to an SV) or a reference to a
subroutine. The section, <i>Using call_sv</i>, shows how you can make
use of <i>call_sv</i>.</p>
</li>
<li><a class='view-title' id="call_pv"></a><strong>call_pv</strong>
<p>The function, <i>call_pv</i>, is similar to <i>call_sv</i> except it
expects its first parameter to be a C char* which identifies the Perl
subroutine you want to call, e.g., <code class="inline"><span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;fred&quot;</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span></code>
.  If the
subroutine you want to call is in another package, just include the
package name in the string, e.g., <code class="inline"><span class="q">&quot;pkg::fred&quot;</span></code>
.</p>
</li>
<li><a class='view-title' id="call_method"></a><strong>call_method</strong>
<p>The function <i>call_method</i> is used to call a method from a Perl
class.  The parameter <code class="inline"><span class="w">methname</span></code>
 corresponds to the name of the method
to be called.  Note that the class that the method belongs to is passed
on the Perl stack rather than in the parameter list. This class can be
either the name of the class (for a static method) or a reference to an
object (for a virtual method).  See <a href="perlobj.html">perlobj</a> for more information on
static and virtual methods and <a href="#Using-call_method">Using call_method</a> for an example
of using <i>call_method</i>.</p>
</li>
<li><a class='view-title' id="call_argv"></a><strong>call_argv</strong>
<p><i>call_argv</i> calls the Perl subroutine specified by the C string
stored in the <code class="inline"><span class="w">subname</span></code>
 parameter. It also takes the usual <code class="inline"><span class="w">flags</span></code>

parameter.  The final parameter, <code class="inline"><span class="w">argv</span></code>
, consists of a NULL-terminated
list of C strings to be passed as parameters to the Perl subroutine.
See <i>Using call_argv</i>.</p>
</li>
</ul>
<p>All the functions return an integer. This is a count of the number of
items returned by the Perl subroutine. The actual items returned by the
subroutine are stored on the Perl stack.</p>
<p>As a general rule you should <i>always</i> check the return value from
these functions.  Even if you are expecting only a particular number of
values to be returned from the Perl subroutine, there is nothing to
stop someone from doing something unexpected--don't say you haven't
been warned.</p>
<a class='view-head1' id="FLAG-VALUES"></a><h2 class='h2' >FLAG VALUES</h2>
<p>The <code class="inline"><span class="w">flags</span></code>
 parameter in all the <i>call_*</i> functions is one of G_VOID,
G_SCALAR, or G_ARRAY, which indicate the call context, OR'ed together
with a bit mask of any combination of the other G_* symbols defined below.</p>
<a class='view-head2' id="G_VOID"></a><h3 class='h3' >G_VOID</h3>
<p>Calls the Perl subroutine in a void context.</p>
<p>This flag has 2 effects:</p>
<dl>
<li>
<p>It indicates to the subroutine being called that it is executing in
a void context (if it executes <i>wantarray</i> the result will be the
undefined value).</p>
</li>
<li>
<p>It ensures that nothing is actually returned from the subroutine.</p>
</li>
</dl>
<p>The value returned by the <i>call_*</i> function indicates how many
items have been returned by the Perl subroutine--in this case it will
be 0.</p>
<a class='view-head2' id="G_SCALAR"></a><h3 class='h3' >G_SCALAR</h3>
<p>Calls the Perl subroutine in a scalar context.  This is the default
context flag setting for all the <i>call_*</i> functions.</p>
<p>This flag has 2 effects:</p>
<dl>
<li>
<p>It indicates to the subroutine being called that it is executing in a
scalar context (if it executes <i>wantarray</i> the result will be false).</p>
</li>
<li>
<p>It ensures that only a scalar is actually returned from the subroutine.
The subroutine can, of course,  ignore the <i>wantarray</i> and return a
list anyway. If so, then only the last element of the list will be
returned.</p>
</li>
</dl>
<p>The value returned by the <i>call_*</i> function indicates how many
items have been returned by the Perl subroutine - in this case it will
be either 0 or 1.</p>
<p>If 0, then you have specified the G_DISCARD flag.</p>
<p>If 1, then the item actually returned by the Perl subroutine will be
stored on the Perl stack - the section <i>Returning a Scalar</i> shows how
to access this value on the stack.  Remember that regardless of how
many items the Perl subroutine returns, only the last one will be
accessible from the stack - think of the case where only one value is
returned as being a list with only one element.  Any other items that
were returned will not exist by the time control returns from the
<i>call_*</i> function.  The section <i>Returning a list in a scalar
context</i> shows an example of this behavior.</p>
<a class='view-head2' id="G_ARRAY"></a><h3 class='h3' >G_ARRAY</h3>
<p>Calls the Perl subroutine in a list context.</p>
<p>As with G_SCALAR, this flag has 2 effects:</p>
<dl>
<li>
<p>It indicates to the subroutine being called that it is executing in a
list context (if it executes <i>wantarray</i> the result will be true).</p>
</li>
<li>
<p>It ensures that all items returned from the subroutine will be
accessible when control returns from the <i>call_*</i> function.</p>
</li>
</dl>
<p>The value returned by the <i>call_*</i> function indicates how many
items have been returned by the Perl subroutine.</p>
<p>If 0, then you have specified the G_DISCARD flag.</p>
<p>If not 0, then it will be a count of the number of items returned by
the subroutine. These items will be stored on the Perl stack.  The
section <i>Returning a list of values</i> gives an example of using the
G_ARRAY flag and the mechanics of accessing the returned items from the
Perl stack.</p>
<a class='view-head2' id="G_DISCARD"></a><h3 class='h3' >G_DISCARD</h3>
<p>By default, the <i>call_*</i> functions place the items returned from
by the Perl subroutine on the stack.  If you are not interested in
these items, then setting this flag will make Perl get rid of them
automatically for you.  Note that it is still possible to indicate a
context to the Perl subroutine by using either G_SCALAR or G_ARRAY.</p>
<p>If you do not set this flag then it is <i>very</i> important that you make
sure that any temporaries (i.e., parameters passed to the Perl
subroutine and values returned from the subroutine) are disposed of
yourself.  The section <i>Returning a Scalar</i> gives details of how to
dispose of these temporaries explicitly and the section <i>Using Perl to
dispose of temporaries</i> discusses the specific circumstances where you
can ignore the problem and let Perl deal with it for you.</p>
<a class='view-head2' id="G_NOARGS"></a><h3 class='h3' >G_NOARGS</h3>
<p>Whenever a Perl subroutine is called using one of the <i>call_*</i>
functions, it is assumed by default that parameters are to be passed to
the subroutine.  If you are not passing any parameters to the Perl
subroutine, you can save a bit of time by setting this flag.  It has
the effect of not creating the <code class="inline"><span class="i">@_</span></code>
 array for the Perl subroutine.</p>
<p>Although the functionality provided by this flag may seem
straightforward, it should be used only if there is a good reason to do
so.  The reason for being cautious is that, even if you have specified
the G_NOARGS flag, it is still possible for the Perl subroutine that
has been called to think that you have passed it parameters.</p>
<p>In fact, what can happen is that the Perl subroutine you have called
can access the <code class="inline"><span class="i">@_</span></code>
 array from a previous Perl subroutine.  This will
occur when the code that is executing the <i>call_*</i> function has
itself been called from another Perl subroutine. The code below
illustrates this</p>
<pre class="verbatim"><ol><li><a name="fred"></a>    sub <span class="m">fred</span></li><li>      <span class="s">{</span> <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;@_\n&quot;</span>  <span class="s">}</span></li><li></li><li><a name="joe"></a>    sub <span class="m">joe</span></li><li>      <span class="s">{</span> <span class="i">&amp;fred</span> <span class="s">}</span></li><li></li><li>    <span class="i">&amp;joe</span><span class="s">(</span><span class="n">1</span><span class="cm">,</span><span class="n">2</span><span class="cm">,</span><span class="n">3</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>This will print</p>
<pre class="verbatim"><ol><li>    <span class="n">1</span> <span class="n">2</span> <span class="n">3</span></li></ol></pre><p>What has happened is that <code class="inline"><span class="w">fred</span></code>
 accesses the <code class="inline"><span class="i">@_</span></code>
 array which
belongs to <code class="inline"><span class="w">joe</span></code>
.</p>
<a class='view-head2' id="G_EVAL"></a><h3 class='h3' >G_EVAL</h3>
<p>It is possible for the Perl subroutine you are calling to terminate
abnormally, e.g., by calling <i>die</i> explicitly or by not actually
existing.  By default, when either of these events occurs, the
process will terminate immediately.  If you want to trap this
type of event, specify the G_EVAL flag.  It will put an <i>eval { }</i>
around the subroutine call.</p>
<p>Whenever control returns from the <i>call_*</i> function you need to
check the <code class="inline"><span class="i">$@</span></code>
 variable as you would in a normal Perl script.</p>
<p>The value returned from the <i>call_*</i> function is dependent on
what other flags have been specified and whether an error has
occurred.  Here are all the different cases that can occur:</p>
<ul>
<li>
<p>If the <i>call_*</i> function returns normally, then the value
returned is as specified in the previous sections.</p>
</li>
<li>
<p>If G_DISCARD is specified, the return value will always be 0.</p>
</li>
<li>
<p>If G_ARRAY is specified <i>and</i> an error has occurred, the return value
will always be 0.</p>
</li>
<li>
<p>If G_SCALAR is specified <i>and</i> an error has occurred, the return value
will be 1 and the value on the top of the stack will be <i>undef</i>. This
means that if you have already detected the error by checking <code class="inline"><span class="i">$@</span></code>
 and
you want the program to continue, you must remember to pop the <i>undef</i>
from the stack.</p>
</li>
</ul>
<p>See <i>Using G_EVAL</i> for details on using G_EVAL.</p>
<a class='view-head2' id="G_KEEPERR"></a><h3 class='h3' >G_KEEPERR</h3>
<p>Using the G_EVAL flag described above will always set <code class="inline"><span class="i">$@</span></code>
: clearing
it if there was no error, and setting it to describe the error if there
was an error in the called code.  This is what you want if your intention
is to handle possible errors, but sometimes you just want to trap errors
and stop them interfering with the rest of the program.</p>
<p>This scenario will mostly be applicable to code that is meant to be called
from within destructors, asynchronous callbacks, and signal handlers.
In such situations, where the code being called has little relation to the
surrounding dynamic context, the main program needs to be insulated from
errors in the called code, even if they can't be handled intelligently.
It may also be useful to do this with code for <code class="inline"><span class="w">__DIE__</span></code>
 or <code class="inline"><span class="w">__WARN__</span></code>

hooks, and <code class="inline"><a class="l_k" href="functions/tie.html">tie</a></code> functions.</p>
<p>The G_KEEPERR flag is meant to be used in conjunction with G_EVAL in
<i>call_*</i> functions that are used to implement such code, or with
<code class="inline"><span class="w">eval_sv</span></code>
.  This flag has no effect on the <code class="inline"><span class="w">call_</span>*</code>
 functions when
G_EVAL is not used.</p>
<p>When G_KEEPERR is used, any error in the called code will terminate the
call as usual, and the error will not propagate beyond the call (as usual
for G_EVAL), but it will not go into <code class="inline"><span class="i">$@</span></code>
.  Instead the error will be
converted into a warning, prefixed with the string "\t(in cleanup)".
This can be disabled using <code class="inline"><a class="l_k" href="functions/no.html">no</a> <span class="w">warnings</span> <span class="q">&#39;misc&#39;</span></code>
.  If there is no error,
<code class="inline"><span class="i">$@</span></code>
 will not be cleared.</p>
<p>Note that the G_KEEPERR flag does not propagate into inner evals; these
may still set <code class="inline"><span class="i">$@</span></code>
.</p>
<p>The G_KEEPERR flag was introduced in Perl version 5.002.</p>
<p>See <i>Using G_KEEPERR</i> for an example of a situation that warrants the
use of this flag.</p>
<a class='view-head2' id="Determining-the-Context"></a><h3 class='h3' >Determining the Context</h3>
<p>As mentioned above, you can determine the context of the currently
executing subroutine in Perl with <i>wantarray</i>.  The equivalent test
can be made in C by using the <code class="inline"><span class="w">GIMME_V</span></code>
 macro, which returns
<code class="inline"><span class="w">G_ARRAY</span></code>
 if you have been called in a list context, <code class="inline"><span class="w">G_SCALAR</span></code>
 if
in a scalar context, or <code class="inline"><span class="w">G_VOID</span></code>
 if in a void context (i.e., the
return value will not be used).  An older version of this macro is
called <code class="inline"><span class="w">GIMME</span></code>
; in a void context it returns <code class="inline"><span class="w">G_SCALAR</span></code>
 instead of
<code class="inline"><span class="w">G_VOID</span></code>
.  An example of using the <code class="inline"><span class="w">GIMME_V</span></code>
 macro is shown in
section <i>Using GIMME_V</i>.</p>
<a class='view-head1' id="EXAMPLES"></a><h2 class='h2' >EXAMPLES</h2>
<p>Enough of the definition talk! Let's have a few examples.</p>
<p>Perl provides many macros to assist in accessing the Perl stack.
Wherever possible, these macros should always be used when interfacing
to Perl internals.  We hope this should make the code less vulnerable
to any changes made to Perl in the future.</p>
<p>Another point worth noting is that in the first series of examples I
have made use of only the <i>call_pv</i> function.  This has been done
to keep the code simpler and ease you into the topic.  Wherever
possible, if the choice is between using <i>call_pv</i> and
<i>call_sv</i>, you should always try to use <i>call_sv</i>.  See
<i>Using call_sv</i> for details.</p>
<a class='view-head2' id="No-Parameters%2c-Nothing-Returned"></a><h3 class='h3' >No Parameters, Nothing Returned</h3>
<p>This first trivial example will call a Perl subroutine, <i>PrintUID</i>, to
print out the UID of the process.</p>
<pre class="verbatim"><ol><li><a name="PrintUID"></a>    sub <span class="m">PrintUID</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;UID is $&lt;\n&quot;</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>and here is a C function to call it</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_PrintUID</span><span class="s">(</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;PrintUID&quot;</span><span class="cm">,</span> <span class="w">G_DISCARD</span>|<span class="w">G_NOARGS</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Simple, eh?</p>
<p>A few points to note about this example:</p>
<dl>
<li>
<p>Ignore <code class="inline"><span class="w">dSP</span></code>
 and <code class="inline"><span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span></code>
 for now. They will be discussed in
the next example.</p>
</li>
<li>
<p>We aren't passing any parameters to <i>PrintUID</i> so G_NOARGS can be
specified.</p>
</li>
<li>
<p>We aren't interested in anything returned from <i>PrintUID</i>, so
G_DISCARD is specified. Even if <i>PrintUID</i> was changed to
return some value(s), having specified G_DISCARD will mean that they
will be wiped by the time control returns from <i>call_pv</i>.</p>
</li>
<li>
<p>As <i>call_pv</i> is being used, the Perl subroutine is specified as a
C string. In this case the subroutine name has been 'hard-wired' into the
code.</p>
</li>
<li>
<p>Because we specified G_DISCARD, it is not necessary to check the value
returned from <i>call_pv</i>. It will always be 0.</p>
</li>
</dl>
<a class='view-head2' id="Passing-Parameters"></a><h3 class='h3' >Passing Parameters</h3>
<p>Now let's make a slightly more complex example. This time we want to
call a Perl subroutine, <code class="inline"><span class="w">LeftString</span></code>
, which will take 2 parameters--a
string ($s) and an integer ($n).  The subroutine will simply
print the first $n characters of the string.</p>
<p>So the Perl subroutine would look like this:</p>
<pre class="verbatim"><ol><li><a name="LeftString"></a>    sub <span class="m">LeftString</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$s</span><span class="cm">,</span> <span class="i">$n</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/print.html">print</a> <a class="l_k" href="functions/substr.html">substr</a><span class="s">(</span><span class="i">$s</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$n</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>The C function required to call <i>LeftString</i> would look like this:</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_LeftString</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <span class="w">char</span> * <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li></li><li>	<span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSVpv</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;LeftString&quot;</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Here are a few notes on the C function <i>call_LeftString</i>.</p>
<dl>
<li>
<p>Parameters are passed to the Perl subroutine using the Perl stack.
This is the purpose of the code beginning with the line <code class="inline"><span class="w">dSP</span></code>
 and
ending with the line <code class="inline"><span class="w">PUTBACK</span></code>
.  The <code class="inline"><span class="w">dSP</span></code>
 declares a local copy
of the stack pointer.  This local copy should <strong>always</strong> be accessed
as <code class="inline"><span class="w">SP</span></code>
.</p>
</li>
<li>
<p>If you are going to put something onto the Perl stack, you need to know
where to put it. This is the purpose of the macro <code class="inline"><span class="w">dSP</span></code>
--it declares
and initializes a <i>local</i> copy of the Perl stack pointer.</p>
<p>All the other macros which will be used in this example require you to
have used this macro.</p>
<p>The exception to this rule is if you are calling a Perl subroutine
directly from an XSUB function. In this case it is not necessary to
use the <code class="inline"><span class="w">dSP</span></code>
 macro explicitly--it will be declared for you
automatically.</p>
</li>
<li>
<p>Any parameters to be pushed onto the stack should be bracketed by the
<code class="inline"><span class="w">PUSHMARK</span></code>
 and <code class="inline"><span class="w">PUTBACK</span></code>
 macros.  The purpose of these two macros, in
this context, is to count the number of parameters you are
pushing automatically.  Then whenever Perl is creating the <code class="inline"><span class="i">@_</span></code>
 array for the
subroutine, it knows how big to make it.</p>
<p>The <code class="inline"><span class="w">PUSHMARK</span></code>
 macro tells Perl to make a mental note of the current
stack pointer. Even if you aren't passing any parameters (like the
example shown in the section <i>No Parameters, Nothing Returned</i>) you
must still call the <code class="inline"><span class="w">PUSHMARK</span></code>
 macro before you can call any of the
<i>call_*</i> functions--Perl still needs to know that there are no
parameters.</p>
<p>The <code class="inline"><span class="w">PUTBACK</span></code>
 macro sets the global copy of the stack pointer to be
the same as our local copy. If we didn't do this, <i>call_pv</i>
wouldn't know where the two parameters we pushed were--remember that
up to now all the stack pointer manipulation we have done is with our
local copy, <i>not</i> the global copy.</p>
</li>
<li>
<p>Next, we come to XPUSHs. This is where the parameters actually get
pushed onto the stack. In this case we are pushing a string and an
integer.</p>
<p>See <a href="perlguts.html#XSUBs-and-the-Argument-Stack">XSUBs and the Argument Stack in perlguts</a> for details
on how the XPUSH macros work.</p>
</li>
<li>
<p>Because we created temporary values (by means of sv_2mortal() calls)
we will have to tidy up the Perl stack and dispose of mortal SVs.</p>
<p>This is the purpose of</p>
<pre class="verbatim"><ol><li>    <span class="w">ENTER</span><span class="sc">;</span></li><li>    <span class="w">SAVETMPS</span><span class="sc">;</span></li></ol></pre><p>at the start of the function, and</p>
<pre class="verbatim"><ol><li>    <span class="w">FREETMPS</span><span class="sc">;</span></li><li>    <span class="w">LEAVE</span><span class="sc">;</span></li></ol></pre><p>at the end. The <code class="inline"><span class="w">ENTER</span></code>
/<code class="inline"><span class="w">SAVETMPS</span></code>
 pair creates a boundary for any
temporaries we create.  This means that the temporaries we get rid of
will be limited to those which were created after these calls.</p>
<p>The <code class="inline"><span class="w">FREETMPS</span></code>
/<code class="inline"><span class="w">LEAVE</span></code>
 pair will get rid of any values returned by
the Perl subroutine (see next example), plus it will also dump the
mortal SVs we have created.  Having <code class="inline"><span class="w">ENTER</span></code>
/<code class="inline"><span class="w">SAVETMPS</span></code>
 at the
beginning of the code makes sure that no other mortals are destroyed.</p>
<p>Think of these macros as working a bit like <code class="inline"><span class="s">{</span></code>
 and <code class="inline"><span class="s">}</span></code>
 in Perl
to limit the scope of local variables.</p>
<p>See the section <i>Using Perl to Dispose of Temporaries</i> for details of
an alternative to using these macros.</p>
</li>
<li>
<p>Finally, <i>LeftString</i> can now be called via the <i>call_pv</i> function.
The only flag specified this time is G_DISCARD. Because we are passing
2 parameters to the Perl subroutine this time, we have not specified
G_NOARGS.</p>
</li>
</dl>
<a class='view-head2' id="Returning-a-Scalar"></a><h3 class='h3' >Returning a Scalar</h3>
<p>Now for an example of dealing with the items returned from a Perl
subroutine.</p>
<p>Here is a Perl subroutine, <i>Adder</i>, that takes 2 integer parameters
and simply returns their sum.</p>
<pre class="verbatim"><ol><li><a name="Adder"></a>    sub <span class="m">Adder</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>        <span class="i">$a</span> + <span class="i">$b</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Because we are now concerned with the return value from <i>Adder</i>, the C
function required to call it is now a bit more complex.</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_Adder</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;Adder&quot;</span><span class="cm">,</span> <span class="w">G_SCALAR</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><span class="w">count</span> != <span class="n">1</span><span class="s">)</span></li><li>            <span class="i">croak</span><span class="s">(</span><span class="q">&quot;Big trouble\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;The sum of %d and %d is %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="w">POPi</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Points to note this time are</p>
<dl>
<li>
<p>The only flag specified this time was G_SCALAR. That means that the <code class="inline"><span class="i">@_</span></code>

array will be created and that the value returned by <i>Adder</i> will
still exist after the call to <i>call_pv</i>.</p>
</li>
<li>
<p>The purpose of the macro <code class="inline"><span class="w">SPAGAIN</span></code>
 is to refresh the local copy of the
stack pointer. This is necessary because it is possible that the memory
allocated to the Perl stack has been reallocated during the
<i>call_pv</i> call.</p>
<p>If you are making use of the Perl stack pointer in your code you must
always refresh the local copy using SPAGAIN whenever you make use
of the <i>call_*</i> functions or any other Perl internal function.</p>
</li>
<li>
<p>Although only a single value was expected to be returned from <i>Adder</i>,
it is still good practice to check the return code from <i>call_pv</i>
anyway.</p>
<p>Expecting a single value is not quite the same as knowing that there
will be one. If someone modified <i>Adder</i> to return a list and we
didn't check for that possibility and take appropriate action the Perl
stack would end up in an inconsistent state. That is something you
<i>really</i> don't want to happen ever.</p>
</li>
<li>
<p>The <code class="inline"><span class="w">POPi</span></code>
 macro is used here to pop the return value from the stack.
In this case we wanted an integer, so <code class="inline"><span class="w">POPi</span></code>
 was used.</p>
<p>Here is the complete list of POP macros available, along with the types
they return.</p>
<pre class="verbatim"><ol><li>    <span class="w">POPs</span>	<span class="w">SV</span></li><li>    <span class="w">POPp</span>	<span class="w">pointer</span></li><li>    <span class="w">POPn</span>	<span class="w">double</span></li><li>    <span class="w">POPi</span>	<span class="w">integer</span></li><li>    <span class="w">POPl</span>	<span class="w">long</span></li></ol></pre></li>
<li>
<p>The final <code class="inline"><span class="w">PUTBACK</span></code>
 is used to leave the Perl stack in a consistent
state before exiting the function.  This is necessary because when we
popped the return value from the stack with <code class="inline"><span class="w">POPi</span></code>
 it updated only our
local copy of the stack pointer.  Remember, <code class="inline"><span class="w">PUTBACK</span></code>
 sets the global
stack pointer to be the same as our local copy.</p>
</li>
</dl>
<a class='view-head2' id="Returning-a-List-of-Values"></a><h3 class='h3' >Returning a List of Values</h3>
<p>Now, let's extend the previous example to return both the sum of the
parameters and the difference.</p>
<p>Here is the Perl subroutine</p>
<pre class="verbatim"><ol><li><a name="AddSubtract"></a>    sub <span class="m">AddSubtract</span></li><li>    <span class="s">{</span></li><li>       <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>       <span class="s">(</span><span class="i">$a</span>+<span class="i">$b</span><span class="cm">,</span> <span class="i">$a</span>-<span class="i">$b</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>and this is the C function</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_AddSubtract</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;AddSubtract&quot;</span><span class="cm">,</span> <span class="w">G_ARRAY</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><span class="w">count</span> != <span class="n">2</span><span class="s">)</span></li><li>            <span class="i">croak</span><span class="s">(</span><span class="q">&quot;Big trouble\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d - %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="w">POPi</span><span class="s">)</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d + %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="w">POPi</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>If <i>call_AddSubtract</i> is called like this</p>
<pre class="verbatim"><ol><li>    <span class="i">call_AddSubtract</span><span class="s">(</span><span class="n">7</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>then here is the output</p>
<pre class="verbatim"><ol><li>    <span class="n">7</span> - <span class="n">4</span> = <span class="n">3</span></li><li>    <span class="n">7</span> + <span class="n">4</span> = <span class="n">11</span></li></ol></pre><p>Notes</p>
<dl>
<li>
<p>We wanted list context, so G_ARRAY was used.</p>
</li>
<li>
<p>Not surprisingly <code class="inline"><span class="w">POPi</span></code>
 is used twice this time because we were
retrieving 2 values from the stack. The important thing to note is that
when using the <code class="inline"><span class="w">POP</span>*</code>
 macros they come off the stack in <i>reverse</i>
order.</p>
</li>
</dl>
<a class='view-head2' id="Returning-a-List-in-a-Scalar-Context"></a><h3 class='h3' >Returning a List in a Scalar Context</h3>
<p>Say the Perl subroutine in the previous section was called in a scalar
context, like this</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_AddSubScalar</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">i</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;AddSubtract&quot;</span><span class="cm">,</span> <span class="w">G_SCALAR</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Items Returned = %d\n&quot;</span><span class="cm">,</span> <span class="w">count</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        for <span class="s">(</span><span class="w">i</span> = <span class="n">1</span><span class="sc">;</span> <span class="w">i</span> &lt;= <span class="w">count</span><span class="sc">;</span> ++<span class="w">i</span><span class="s">)</span></li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Value %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">i</span><span class="cm">,</span> <span class="w">POPi</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>The other modification made is that <i>call_AddSubScalar</i> will print the
number of items returned from the Perl subroutine and their value (for
simplicity it assumes that they are integer).  So if
<i>call_AddSubScalar</i> is called</p>
<pre class="verbatim"><ol><li>    <span class="i">call_AddSubScalar</span><span class="s">(</span><span class="n">7</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>then the output will be</p>
<pre class="verbatim"><ol><li>    <span class="w">Items</span> <span class="w">Returned</span> = <span class="n">1</span></li><li>    <span class="w">Value</span> <span class="n">1</span> = <span class="n">3</span></li></ol></pre><p>In this case the main point to note is that only the last item in the
list is returned from the subroutine. <i>AddSubtract</i> actually made it back to
<i>call_AddSubScalar</i>.</p>
<a class='view-head2' id="Returning-Data-from-Perl-via-the-Parameter-List"></a><h3 class='h3' >Returning Data from Perl via the Parameter List</h3>
<p>It is also possible to return values directly via the parameter
list--whether it is actually desirable to do it is another matter entirely.</p>
<p>The Perl subroutine, <i>Inc</i>, below takes 2 parameters and increments
each directly.</p>
<pre class="verbatim"><ol><li><a name="Inc"></a>    sub <span class="m">Inc</span></li><li>    <span class="s">{</span></li><li>        ++ <span class="i">$_</span>[<span class="n">0</span>]<span class="sc">;</span></li><li>        ++ <span class="i">$_</span>[<span class="n">1</span>]<span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>and here is a C function to call it.</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_Inc</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li>        <span class="w">SV</span> * <span class="w">sva</span><span class="sc">;</span></li><li>        <span class="w">SV</span> * <span class="w">svb</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="w">sva</span> = <span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">svb</span> = <span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="w">sva</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="w">svb</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;Inc&quot;</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><span class="w">count</span> != <span class="n">0</span><span class="s">)</span></li><li>            <span class="w">croak</span> <span class="s">(</span><span class="q">&quot;call_Inc: expected 0 values from &#39;Inc&#39;, got %d\n&quot;</span><span class="cm">,</span></li><li>                   <span class="w">count</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d + 1 = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="i">SvIV</span><span class="s">(</span><span class="w">sva</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d + 1 = %d\n&quot;</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="i">SvIV</span><span class="s">(</span><span class="w">svb</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>	<span class="w">FREETMPS</span><span class="sc">;</span></li><li>	<span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>To be able to access the two parameters that were pushed onto the stack
after they return from <i>call_pv</i> it is necessary to make a note
of their addresses--thus the two variables <code class="inline"><span class="w">sva</span></code>
 and <code class="inline"><span class="w">svb</span></code>
.</p>
<p>The reason this is necessary is that the area of the Perl stack which
held them will very likely have been overwritten by something else by
the time control returns from <i>call_pv</i>.</p>
<a class='view-head2' id="Using-G_EVAL"></a><h3 class='h3' >Using G_EVAL</h3>
<p>Now an example using G_EVAL. Below is a Perl subroutine which computes
the difference of its 2 parameters. If this would result in a negative
result, the subroutine calls <i>die</i>.</p>
<pre class="verbatim"><ol><li><a name="Subtract"></a>    sub <span class="m">Subtract</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;death can be fatal\n&quot;</span> if <span class="i">$a</span> &lt; <span class="i">$b</span><span class="sc">;</span></li><li></li><li>        <span class="i">$a</span> - <span class="i">$b</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>and some C to call it</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_Subtract</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;Subtract&quot;</span><span class="cm">,</span> <span class="w">G_EVAL</span>|<span class="w">G_SCALAR</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Check the eval first */</span></li><li>        if <span class="s">(</span><span class="i">SvTRUE</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span><span class="s">)</span></li><li>        <span class="s">{</span></li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Uh oh - %s\n&quot;</span><span class="cm">,</span> <span class="i">SvPV_nolen</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>            <span class="w">POPs</span><span class="sc">;</span></li><li>        <span class="s">}</span></li><li>        else</li><li>        <span class="s">{</span></li><li>            if <span class="s">(</span><span class="w">count</span> != <span class="n">1</span><span class="s">)</span></li><li>               <span class="i">croak</span><span class="s">(</span><span class="q">&quot;call_Subtract: wanted 1 value from &#39;Subtract&#39;, got %d\n&quot;</span><span class="cm">,</span></li><li>                        <span class="w">count</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d - %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="w">POPi</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="s">}</span></li><li></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>If <i>call_Subtract</i> is called thus</p>
<pre class="verbatim"><ol><li>    <span class="i">call_Subtract</span><span class="s">(</span><span class="n">4</span><span class="cm">,</span> <span class="n">5</span><span class="s">)</span></li></ol></pre><p>the following will be printed</p>
<pre class="verbatim"><ol><li>    <span class="w">Uh</span> <span class="w">oh</span> - <span class="w">death</span> <span class="w">can</span> <span class="w">be</span> <span class="w">fatal</span></li></ol></pre><p>Notes</p>
<dl>
<li>
<p>We want to be able to catch the <i>die</i> so we have used the G_EVAL
flag.  Not specifying this flag would mean that the program would
terminate immediately at the <i>die</i> statement in the subroutine
<i>Subtract</i>.</p>
</li>
<li>
<p>The code</p>
<pre class="verbatim"><ol><li>    if <span class="s">(</span><span class="i">SvTRUE</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Uh oh - %s\n&quot;</span><span class="cm">,</span> <span class="i">SvPV_nolen</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">POPs</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>is the direct equivalent of this bit of Perl</p>
<pre class="verbatim"><ol><li>    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Uh oh - $@\n&quot;</span> if <span class="i">$@</span><span class="sc">;</span></li></ol></pre><p><code class="inline"><span class="w">PL_errgv</span></code>
 is a perl global of type <code class="inline"><span class="w">GV</span> *</code>
 that points to the
symbol table entry containing the error.  <code class="inline"><span class="w">ERRSV</span></code>
 therefore
refers to the C equivalent of <code class="inline"><span class="i">$@</span></code>
.</p>
</li>
<li>
<p>Note that the stack is popped using <code class="inline"><span class="w">POPs</span></code>
 in the block where
<code class="inline"><span class="i">SvTRUE</span><span class="s">(</span><span class="w">ERRSV</span><span class="s">)</span></code>
 is true.  This is necessary because whenever a
<i>call_*</i> function invoked with G_EVAL|G_SCALAR returns an error,
the top of the stack holds the value <i>undef</i>. Because we want the
program to continue after detecting this error, it is essential that
the stack be tidied up by removing the <i>undef</i>.</p>
</li>
</dl>
<a class='view-head2' id="Using-G_KEEPERR"></a><h3 class='h3' >Using G_KEEPERR</h3>
<p>Consider this rather facetious example, where we have used an XS
version of the call_Subtract example above inside a destructor:</p>
<pre class="verbatim"><ol><li><a name="package-Foo"></a>    package <span class="i">Foo</span><span class="sc">;</span></li><li><a name="new"></a>    sub <span class="m">new</span> <span class="s">{</span> <a class="l_k" href="functions/bless.html">bless</a> <span class="s">{</span><span class="s">}</span><span class="cm">,</span> <span class="i">$_</span>[<span class="n">0</span>] <span class="s">}</span></li><li><a name="Subtract"></a>    sub <span class="m">Subtract</span> <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$a</span><span class="cm">,</span><span class="i">$b</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;death can be fatal&quot;</span> if <span class="i">$a</span> &lt; <span class="i">$b</span><span class="sc">;</span></li><li>        <span class="i">$a</span> - <span class="i">$b</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li><a name="DESTROY"></a>    sub <span class="m">DESTROY</span> <span class="s">{</span> <span class="i">call_Subtract</span><span class="s">(</span><span class="n">5</span><span class="cm">,</span> <span class="n">4</span><span class="s">)</span><span class="sc">;</span> <span class="s">}</span></li><li><a name="foo"></a>    sub <span class="m">foo</span> <span class="s">{</span> <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;foo dies&quot;</span><span class="sc">;</span> <span class="s">}</span></li><li></li><li><a name="package-main"></a>    package <span class="i">main</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>	<a class="l_k" href="functions/my.html">my</a> <span class="i">$foo</span> = <span class="w">Foo</span><span class="w">-&gt;new</span><span class="sc">;</span></li><li>	<a class="l_k" href="functions/eval.html">eval</a> <span class="s">{</span> <span class="i">$foo</span><span class="i">-&gt;foo</span> <span class="s">}</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li>    <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Saw: $@&quot;</span> if <span class="i">$@</span><span class="sc">;</span>             <span class="c"># should be, but isn&#39;t</span></li></ol></pre><p>This example will fail to recognize that an error occurred inside the
<code class="inline"><a class="l_k" href="functions/eval.html">eval</a> <span class="s">{</span><span class="s">}</span></code>
.  Here's why: the call_Subtract code got executed while perl
was cleaning up temporaries when exiting the outer braced block, and because
call_Subtract is implemented with <i>call_pv</i> using the G_EVAL
flag, it promptly reset <code class="inline"><span class="i">$@</span></code>
.  This results in the failure of the
outermost test for <code class="inline"><span class="i">$@</span></code>
, and thereby the failure of the error trap.</p>
<p>Appending the G_KEEPERR flag, so that the <i>call_pv</i> call in
call_Subtract reads:</p>
<pre class="verbatim"><ol><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;Subtract&quot;</span><span class="cm">,</span> <span class="w">G_EVAL</span>|<span class="w">G_SCALAR</span>|<span class="w">G_KEEPERR</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>will preserve the error and restore reliable error handling.</p>
<a class='view-head2' id="Using-call_sv"></a><h3 class='h3' >Using call_sv</h3>
<p>In all the previous examples I have 'hard-wired' the name of the Perl
subroutine to be called from C.  Most of the time though, it is more
convenient to be able to specify the name of the Perl subroutine from
within the Perl script.</p>
<p>Consider the Perl code below</p>
<pre class="verbatim"><ol><li><a name="fred"></a>    sub <span class="m">fred</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Hello there\n&quot;</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="i">CallSubPV</span><span class="s">(</span><span class="q">&quot;fred&quot;</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Here is a snippet of XSUB which defines <i>CallSubPV</i>.</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">CallSubPV</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></li><li>    	<span class="w">char</span> *	<span class="w">name</span></li><li>    	<span class="w">CODE</span><span class="co">:</span></li><li>	<span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>	<span class="i">call_pv</span><span class="s">(</span><span class="w">name</span><span class="cm">,</span> <span class="w">G_DISCARD</span>|<span class="w">G_NOARGS</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>That is fine as far as it goes. The thing is, the Perl subroutine
can be specified as only a string.  For Perl 4 this was adequate,
but Perl 5 allows references to subroutines and anonymous subroutines.
This is where <i>call_sv</i> is useful.</p>
<p>The code below for <i>CallSubSV</i> is identical to <i>CallSubPV</i> except
that the <code class="inline"><span class="w">name</span></code>
 parameter is now defined as an SV* and we use
<i>call_sv</i> instead of <i>call_pv</i>.</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">CallSubSV</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></li><li>    	<span class="w">SV</span> *	<span class="w">name</span></li><li>    	<span class="w">CODE</span><span class="co">:</span></li><li>	<span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>	<span class="i">call_sv</span><span class="s">(</span><span class="w">name</span><span class="cm">,</span> <span class="w">G_DISCARD</span>|<span class="w">G_NOARGS</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>Because we are using an SV to call <i>fred</i> the following can all be used:</p>
<pre class="verbatim"><ol><li>    <span class="i">CallSubSV</span><span class="s">(</span><span class="q">&quot;fred&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">CallSubSV</span><span class="s">(</span>\<span class="i">&amp;fred</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">$ref</span> = \<span class="i">&amp;fred</span><span class="sc">;</span></li><li>    <span class="i">CallSubSV</span><span class="s">(</span><span class="i">$ref</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">CallSubSV</span><span class="s">(</span> <a class="l_k" href="functions/sub.html">sub</a> <span class="s">{</span> <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Hello there\n&quot;</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span></li></ol></pre><p>As you can see, <i>call_sv</i> gives you much greater flexibility in
how you can specify the Perl subroutine.</p>
<p>You should note that, if it is necessary to store the SV (<code class="inline"><span class="w">name</span></code>
 in the
example above) which corresponds to the Perl subroutine so that it can
be used later in the program, it not enough just to store a copy of the
pointer to the SV. Say the code above had been like this:</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">SV</span> * <span class="w">rememberSub</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">SaveSub1</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></li><li>    	<span class="w">SV</span> *	<span class="w">name</span></li><li>    	<span class="w">CODE</span><span class="co">:</span></li><li>	<span class="w">rememberSub</span> = <span class="w">name</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">CallSavedSub1</span><span class="s">(</span><span class="s">)</span></li><li>    	<span class="w">CODE</span><span class="co">:</span></li><li>	<span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>	<span class="i">call_sv</span><span class="s">(</span><span class="w">rememberSub</span><span class="cm">,</span> <span class="w">G_DISCARD</span>|<span class="w">G_NOARGS</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>The reason this is wrong is that, by the time you come to use the
pointer <code class="inline"><span class="w">rememberSub</span></code>
 in <code class="inline"><span class="w">CallSavedSub1</span></code>
, it may or may not still refer
to the Perl subroutine that was recorded in <code class="inline"><span class="w">SaveSub1</span></code>
.  This is
particularly true for these cases:</p>
<pre class="verbatim"><ol><li>    <span class="i">SaveSub1</span><span class="s">(</span>\<span class="i">&amp;fred</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">CallSavedSub1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="i">SaveSub1</span><span class="s">(</span> <a class="l_k" href="functions/sub.html">sub</a> <span class="s">{</span> <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;Hello there\n&quot;</span> <span class="s">}</span> <span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">CallSavedSub1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>By the time each of the <code class="inline"><span class="w">SaveSub1</span></code>
 statements above has been executed,
the SV*s which corresponded to the parameters will no longer exist.
Expect an error message from Perl of the form</p>
<pre class="verbatim"><ol><li>    <span class="w">Can&#39;t</span> <a class="l_k" href="functions/use.html">use</a> <span class="w">an</span> <span class="w">undefined</span> <span class="w">value</span> <span class="w">as</span> <span class="w">a</span> <span class="w">subroutine</span> <span class="w">reference</span> <span class="w">at</span> ...</li></ol></pre><p>for each of the <code class="inline"><span class="w">CallSavedSub1</span></code>
 lines.</p>
<p>Similarly, with this code</p>
<pre class="verbatim"><ol><li>    <span class="i">$ref</span> = \<span class="i">&amp;fred</span><span class="sc">;</span></li><li>    <span class="i">SaveSub1</span><span class="s">(</span><span class="i">$ref</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">$ref</span> = <span class="n">47</span><span class="sc">;</span></li><li>    <span class="i">CallSavedSub1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>you can expect one of these messages (which you actually get is dependent on
the version of Perl you are using)</p>
<pre class="verbatim"><ol><li>    <span class="w">Not</span> <span class="w">a</span> <span class="w">CODE</span> <span class="w">reference</span> <span class="w">at</span> ...</li><li>    <span class="w">Undefined</span> <span class="w">subroutine</span> <span class="i">&amp;main::47</span> <span class="w">called</span> ...</li></ol></pre><p>The variable $ref may have referred to the subroutine <code class="inline"><span class="w">fred</span></code>

whenever the call to <code class="inline"><span class="w">SaveSub1</span></code>
 was made but by the time
<code class="inline"><span class="w">CallSavedSub1</span></code>
 gets called it now holds the number <code class="inline"><span class="n">47</span></code>
. Because we
saved only a pointer to the original SV in <code class="inline"><span class="w">SaveSub1</span></code>
, any changes to
$ref will be tracked by the pointer <code class="inline"><span class="w">rememberSub</span></code>
. This means that
whenever <code class="inline"><span class="w">CallSavedSub1</span></code>
 gets called, it will attempt to execute the
code which is referenced by the SV* <code class="inline"><span class="w">rememberSub</span></code>
.  In this case
though, it now refers to the integer <code class="inline"><span class="n">47</span></code>
, so expect Perl to complain
loudly.</p>
<p>A similar but more subtle problem is illustrated with this code:</p>
<pre class="verbatim"><ol><li>    <span class="i">$ref</span> = \<span class="i">&amp;fred</span><span class="sc">;</span></li><li>    <span class="i">SaveSub1</span><span class="s">(</span><span class="i">$ref</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">$ref</span> = \<span class="i">&amp;joe</span><span class="sc">;</span></li><li>    <span class="i">CallSavedSub1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>This time whenever <code class="inline"><span class="w">CallSavedSub1</span></code>
 gets called it will execute the Perl
subroutine <code class="inline"><span class="w">joe</span></code>
 (assuming it exists) rather than <code class="inline"><span class="w">fred</span></code>
 as was
originally requested in the call to <code class="inline"><span class="w">SaveSub1</span></code>
.</p>
<p>To get around these problems it is necessary to take a full copy of the
SV.  The code below shows <code class="inline"><span class="w">SaveSub2</span></code>
 modified to do that.</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">SV</span> * <span class="w">keepSub</span> = <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">SaveSub2</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></li><li>        <span class="w">SV</span> *	<span class="w">name</span></li><li>    	<span class="w">CODE</span><span class="co">:</span></li><li>     	<span class="q">/* Take a copy of the callback */</span></li><li>    	if <span class="s">(</span><span class="w">keepSub</span> == <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="s">)</span></li><li>    	    /<span class="i">* First</span> <a class="l_k" href="functions/time.html">time</a><span class="cm">,</span> <span class="w">so</span> <span class="w">create</span> <span class="w">a</span> <span class="w">new</span> <span class="w">SV</span> *<span class="q">/</span></li><li>	    <span class="q">	    keepSub = newSVsv(name);</span></li><li>    	<span class="q">    	else</span></li><li>    	    <span class="q">    	    /</span>* <span class="w">Been</span> <span class="w">here</span> <span class="w">before</span><span class="cm">,</span> <span class="w">so</span> <span class="w">overwrite</span> *<span class="q">/</span></li><li>	    <span class="q">	    SvSetSV(keepSub, name);</span></li><li></li><li>    <span class="q">    void</span></li><li>    <span class="q">    CallSavedSub2()</span></li><li>    	<span class="q">    	CODE:</span></li><li>	<span class="q">	PUSHMARK(SP);</span></li><li>	<span class="q">	call_sv(keepSub, G_DISCARD|G_NOARGS);</span></li></ol></pre><p>To avoid creating a new SV every time <code class="inline"><span class="w">SaveSub2</span></code>
 is called,
the function first checks to see if it has been called before.  If not,
then space for a new SV is allocated and the reference to the Perl
subroutine <code class="inline"><span class="w">name</span></code>
 is copied to the variable <code class="inline"><span class="w">keepSub</span></code>
 in one
operation using <code class="inline"><span class="w">newSVsv</span></code>
.  Thereafter, whenever <code class="inline"><span class="w">SaveSub2</span></code>
 is called,
the existing SV, <code class="inline"><span class="w">keepSub</span></code>
, is overwritten with the new value using
<code class="inline"><span class="w">SvSetSV</span></code>
.</p>
<a class='view-head2' id="Using-call_argv"></a><h3 class='h3' >Using call_argv</h3>
<p>Here is a Perl subroutine which prints whatever parameters are passed
to it.</p>
<pre class="verbatim"><ol><li><a name="PrintList"></a>    sub <span class="m">PrintList</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">@list</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li></li><li>        foreach <span class="s">(</span><span class="i">@list</span><span class="s">)</span> <span class="s">{</span> <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;$_\n&quot;</span> <span class="s">}</span></li><li>    <span class="s">}</span></li></ol></pre><p>And here is an example of <i>call_argv</i> which will call
<i>PrintList</i>.</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">char</span> * <span class="w">words</span><span class="s">[</span><span class="s">]</span> = <span class="s">{</span><span class="q">&quot;alpha&quot;</span><span class="cm">,</span> <span class="q">&quot;beta&quot;</span><span class="cm">,</span> <span class="q">&quot;gamma&quot;</span><span class="cm">,</span> <span class="q">&quot;delta&quot;</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">}</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_PrintList</span><span class="s">(</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li></li><li>        <span class="i">call_argv</span><span class="s">(</span><span class="q">&quot;PrintList&quot;</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="cm">,</span> <span class="w">words</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Note that it is not necessary to call <code class="inline"><span class="w">PUSHMARK</span></code>
 in this instance.
This is because <i>call_argv</i> will do it for you.</p>
<a class='view-head2' id="Using-call_method"></a><h3 class='h3' >Using call_method</h3>
<p>Consider the following Perl code:</p>
<pre class="verbatim"><ol><li>    <span class="s">{</span></li><li><a name="package-Mine"></a>        package <span class="i">Mine</span><span class="sc">;</span></li><li></li><li><a name="new"></a>        sub <span class="m">new</span></li><li>        <span class="s">{</span></li><li>            <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$type</span><span class="s">)</span> = <a class="l_k" href="functions/shift.html">shift</a><span class="sc">;</span></li><li>            <a class="l_k" href="functions/bless.html">bless</a> <span class="s">[</span><span class="i">@_</span><span class="s">]</span></li><li>        <span class="s">}</span></li><li></li><li><a name="Display"></a>        sub <span class="m">Display</span></li><li>        <span class="s">{</span></li><li>            <a class="l_k" href="functions/my.html">my</a> <span class="s">(</span><span class="i">$self</span><span class="cm">,</span> <span class="i">$index</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>            <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;$index: $$self[$index]\n&quot;</span><span class="sc">;</span></li><li>        <span class="s">}</span></li><li></li><li><a name="PrintID"></a>        sub <span class="m">PrintID</span></li><li>        <span class="s">{</span></li><li>            <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$class</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>            <a class="l_k" href="functions/print.html">print</a> <span class="q">&quot;This is Class $class version 1.0\n&quot;</span><span class="sc">;</span></li><li>        <span class="s">}</span></li><li><a name="package-main"></a>    <span class="s">}</span></li></ol></pre><p>It implements just a very simple class to manage an array.  Apart from
the constructor, <code class="inline"><span class="w">new</span></code>
, it declares methods, one static and one
virtual. The static method, <code class="inline"><span class="w">PrintID</span></code>
, prints out simply the class
name and a version number. The virtual method, <code class="inline"><span class="w">Display</span></code>
, prints out a
single element of the array.  Here is an all-Perl example of using it.</p>
<pre class="verbatim"><ol><li>    <span class="i">$a</span> = <span class="w">Mine</span><span class="w">-&gt;new</span><span class="s">(</span><span class="q">&#39;red&#39;</span><span class="cm">,</span> <span class="q">&#39;green&#39;</span><span class="cm">,</span> <span class="q">&#39;blue&#39;</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">$a</span><span class="i">-&gt;Display</span><span class="s">(</span><span class="n">1</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">Mine</span><span class="w">-&gt;PrintID</span><span class="sc">;</span></li></ol></pre><p>will print</p>
<pre class="verbatim"><ol><li>    <span class="n">1</span><span class="co">:</span> <span class="w">green</span></li><li>    <span class="w">This</span> <span class="w">is</span> <span class="w">Class</span> <span class="w">Mine</span> <span class="w">version</span> <span class="n">1.0</span></li></ol></pre><p>Calling a Perl method from C is fairly straightforward. The following
things are required:</p>
<ul>
<li>
<p>A reference to the object for a virtual method or the name of the class
for a static method</p>
</li>
<li>
<p>The name of the method</p>
</li>
<li>
<p>Any other parameters specific to the method</p>
</li>
</ul>
<p>Here is a simple XSUB which illustrates the mechanics of calling both
the <code class="inline"><span class="w">PrintID</span></code>
 and <code class="inline"><span class="w">Display</span></code>
 methods from C.</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">call_Method</span><span class="s">(</span><a class="l_k" href="functions/ref.html">ref</a><span class="cm">,</span> <span class="w">method</span><span class="cm">,</span> <a class="l_k" href="functions/index.html">index</a><span class="s">)</span></li><li>        <span class="w">SV</span> *	<a class="l_k" href="functions/ref.html">ref</a></li><li>        <span class="w">char</span> *	<span class="w">method</span></li><li>        <a class="l_k" href="functions/int.html">int</a>		<a class="l_k" href="functions/index.html">index</a></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><a class="l_k" href="functions/ref.html">ref</a><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><a class="l_k" href="functions/index.html">index</a><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="i">call_method</span><span class="s">(</span><span class="w">method</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">call_PrintID</span><span class="s">(</span><span class="w">class</span><span class="cm">,</span> <span class="w">method</span><span class="s">)</span></li><li>        <span class="w">char</span> *	<span class="w">class</span></li><li>        <span class="w">char</span> *	<span class="w">method</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSVpv</span><span class="s">(</span><span class="w">class</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="i">call_method</span><span class="s">(</span><span class="w">method</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>So the methods <code class="inline"><span class="w">PrintID</span></code>
 and <code class="inline"><span class="w">Display</span></code>
 can be invoked like this:</p>
<pre class="verbatim"><ol><li>    <span class="i">$a</span> = <span class="w">Mine</span><span class="w">-&gt;new</span><span class="s">(</span><span class="q">&#39;red&#39;</span><span class="cm">,</span> <span class="q">&#39;green&#39;</span><span class="cm">,</span> <span class="q">&#39;blue&#39;</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">call_Method</span><span class="s">(</span><span class="i">$a</span><span class="cm">,</span> <span class="q">&#39;Display&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="i">call_PrintID</span><span class="s">(</span><span class="q">&#39;Mine&#39;</span><span class="cm">,</span> <span class="q">&#39;PrintID&#39;</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>The only thing to note is that, in both the static and virtual methods,
the method name is not passed via the stack--it is used as the first
parameter to <i>call_method</i>.</p>
<a class='view-head2' id="Using-GIMME_V"></a><h3 class='h3' >Using GIMME_V</h3>
<p>Here is a trivial XSUB which prints the context in which it is
currently executing.</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">PrintContext</span><span class="s">(</span><span class="s">)</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="w">I32</span> <span class="w">gimme</span> = <span class="w">GIMME_V</span><span class="sc">;</span></li><li>        if <span class="s">(</span><span class="w">gimme</span> == <span class="w">G_VOID</span><span class="s">)</span></li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Context is Void\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>        else if <span class="s">(</span><span class="w">gimme</span> == <span class="w">G_SCALAR</span><span class="s">)</span></li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Context is Scalar\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>        else</li><li>            <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Context is Array\n&quot;</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>And here is some Perl to test it.</p>
<pre class="verbatim"><ol><li>    <span class="w">PrintContext</span><span class="sc">;</span></li><li>    <span class="i">$a</span> = <span class="w">PrintContext</span><span class="sc">;</span></li><li>    <span class="i">@a</span> = <span class="w">PrintContext</span><span class="sc">;</span></li></ol></pre><p>The output from that will be</p>
<pre class="verbatim"><ol><li>    <span class="w">Context</span> <span class="w">is</span> <span class="w">Void</span></li><li>    <span class="w">Context</span> <span class="w">is</span> <span class="w">Scalar</span></li><li>    <span class="w">Context</span> <span class="w">is</span> <span class="w">Array</span></li></ol></pre><a class='view-head2' id="Using-Perl-to-Dispose-of-Temporaries"></a><h3 class='h3' >Using Perl to Dispose of Temporaries</h3>
<p>In the examples given to date, any temporaries created in the callback
(i.e., parameters passed on the stack to the <i>call_*</i> function or
values returned via the stack) have been freed by one of these methods:</p>
<ul>
<li>
<p>Specifying the G_DISCARD flag with <i>call_*</i></p>
</li>
<li>
<p>Explicitly using the <code class="inline"><span class="w">ENTER</span></code>
/<code class="inline"><span class="w">SAVETMPS</span></code>
--<code class="inline"><span class="w">FREETMPS</span></code>
/<code class="inline"><span class="w">LEAVE</span></code>
 pairing</p>
</li>
</ul>
<p>There is another method which can be used, namely letting Perl do it
for you automatically whenever it regains control after the callback
has terminated.  This is done by simply not using the</p>
<pre class="verbatim"><ol><li>    <span class="w">ENTER</span><span class="sc">;</span></li><li>    <span class="w">SAVETMPS</span><span class="sc">;</span></li><li>    ...</li><li>    <span class="w">FREETMPS</span><span class="sc">;</span></li><li>    <span class="w">LEAVE</span><span class="sc">;</span></li></ol></pre><p>sequence in the callback (and not, of course, specifying the G_DISCARD
flag).</p>
<p>If you are going to use this method you have to be aware of a possible
memory leak which can arise under very specific circumstances.  To
explain these circumstances you need to know a bit about the flow of
control between Perl and the callback routine.</p>
<p>The examples given at the start of the document (an error handler and
an event driven program) are typical of the two main sorts of flow
control that you are likely to encounter with callbacks.  There is a
very important distinction between them, so pay attention.</p>
<p>In the first example, an error handler, the flow of control could be as
follows.  You have created an interface to an external library.
Control can reach the external library like this</p>
<pre class="verbatim"><ol><li>    <span class="w">perl</span> --&gt; <span class="w">XSUB</span> --&gt; <span class="w">external</span> <span class="w">library</span></li></ol></pre><p>Whilst control is in the library, an error condition occurs. You have
previously set up a Perl callback to handle this situation, so it will
get executed. Once the callback has finished, control will drop back to
Perl again.  Here is what the flow of control will be like in that
situation</p>
<pre class="verbatim"><ol><li>    <span class="w">perl</span> --&gt; <span class="w">XSUB</span> --&gt; <span class="w">external</span> <span class="w">library</span></li><li>                      ...</li><li>                      <span class="w">error</span> <span class="w">occurs</span></li><li>                      ...</li><li>                      <span class="w">external</span> <span class="w">library</span> --&gt; <span class="w">call_</span>* --&gt; <span class="w">perl</span></li><li>                                                          |</li><li>    <span class="w">perl</span> &lt;-- <span class="w">XSUB</span> &lt;-- <span class="w">external</span> <span class="w">library</span> &lt;-- <span class="w">call_</span>* &lt;----+</li></ol></pre><p>After processing of the error using <i>call_*</i> is completed,
control reverts back to Perl more or less immediately.</p>
<p>In the diagram, the further right you go the more deeply nested the
scope is.  It is only when control is back with perl on the extreme
left of the diagram that you will have dropped back to the enclosing
scope and any temporaries you have left hanging around will be freed.</p>
<p>In the second example, an event driven program, the flow of control
will be more like this</p>
<pre class="verbatim"><ol><li>    <span class="w">perl</span> --&gt; <span class="w">XSUB</span> --&gt; <span class="w">event</span> <span class="w">handler</span></li><li>                      ...</li><li>                      <span class="w">event</span> <span class="w">handler</span> --&gt; <span class="w">call_</span>* --&gt; <span class="w">perl</span></li><li>                                                       |</li><li>                      <span class="w">event</span> <span class="w">handler</span> &lt;-- <span class="w">call_</span>* &lt;----+</li><li>                      ...</li><li>                      <span class="w">event</span> <span class="w">handler</span> --&gt; <span class="w">call_</span>* --&gt; <span class="w">perl</span></li><li>                                                       |</li><li>                      <span class="w">event</span> <span class="w">handler</span> &lt;-- <span class="w">call_</span>* &lt;----+</li><li>                      ...</li><li>                      <span class="w">event</span> <span class="w">handler</span> --&gt; <span class="w">call_</span>* --&gt; <span class="w">perl</span></li><li>                                                       |</li><li>                      <span class="w">event</span> <span class="w">handler</span> &lt;-- <span class="w">call_</span>* &lt;----+</li></ol></pre><p>In this case the flow of control can consist of only the repeated
sequence</p>
<pre class="verbatim"><ol><li>    <span class="w">event</span> <span class="w">handler</span> --&gt; <span class="w">call_</span>* --&gt; <span class="w">perl</span></li></ol></pre><p>for practically the complete duration of the program.  This means that
control may <i>never</i> drop back to the surrounding scope in Perl at the
extreme left.</p>
<p>So what is the big problem? Well, if you are expecting Perl to tidy up
those temporaries for you, you might be in for a long wait.  For Perl
to dispose of your temporaries, control must drop back to the
enclosing scope at some stage.  In the event driven scenario that may
never happen.  This means that, as time goes on, your program will
create more and more temporaries, none of which will ever be freed. As
each of these temporaries consumes some memory your program will
eventually consume all the available memory in your system--kapow!</p>
<p>So here is the bottom line--if you are sure that control will revert
back to the enclosing Perl scope fairly quickly after the end of your
callback, then it isn't absolutely necessary to dispose explicitly of
any temporaries you may have created. Mind you, if you are at all
uncertain about what to do, it doesn't do any harm to tidy up anyway.</p>
<a class='view-head2' id="Strategies-for-Storing-Callback-Context-Information"></a><h3 class='h3' >Strategies for Storing Callback Context Information</h3>
<p>Potentially one of the trickiest problems to overcome when designing a
callback interface can be figuring out how to store the mapping between
the C callback function and the Perl equivalent.</p>
<p>To help understand why this can be a real problem first consider how a
callback is set up in an all C environment.  Typically a C API will
provide a function to register a callback.  This will expect a pointer
to a function as one of its parameters.  Below is a call to a
hypothetical function <code class="inline"><span class="w">register_fatal</span></code>
 which registers the C function
to get called when a fatal error occurs.</p>
<pre class="verbatim"><ol><li>    <span class="i">register_fatal</span><span class="s">(</span><span class="w">cb1</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>The single parameter <code class="inline"><span class="w">cb1</span></code>
 is a pointer to a function, so you must
have defined <code class="inline"><span class="w">cb1</span></code>
 in your code, say something like this</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">cb1</span><span class="s">(</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;Fatal Error\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/exit.html">exit</a><span class="s">(</span><span class="n">1</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Now change that to call a Perl subroutine instead</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">SV</span> * <span class="w">callback</span> = <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">cb1</span><span class="s">(</span><span class="s">)</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Call the Perl sub to process the callback */</span></li><li>        <span class="i">call_sv</span><span class="s">(</span><span class="w">callback</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">register_fatal</span><span class="s">(</span><span class="w">fn</span><span class="s">)</span></li><li>        <span class="w">SV</span> *	<span class="w">fn</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="q">/* Remember the Perl sub */</span></li><li>        if <span class="s">(</span><span class="w">callback</span> == <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="s">)</span></li><li>            <span class="w">callback</span> = <span class="i">newSVsv</span><span class="s">(</span><span class="w">fn</span><span class="s">)</span><span class="sc">;</span></li><li>        else</li><li>            <span class="i">SvSetSV</span><span class="s">(</span><span class="w">callback</span><span class="cm">,</span> <span class="w">fn</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* register the callback with the external library */</span></li><li>        <span class="i">register_fatal</span><span class="s">(</span><span class="w">cb1</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>where the Perl equivalent of <code class="inline"><span class="w">register_fatal</span></code>
 and the callback it
registers, <code class="inline"><span class="w">pcb1</span></code>
, might look like this</p>
<pre class="verbatim"><ol><li>    <span class="c"># Register the sub pcb1</span></li><li>    <span class="i">register_fatal</span><span class="s">(</span>\<span class="i">&amp;pcb1</span><span class="s">)</span><span class="sc">;</span></li><li></li><li><a name="pcb1"></a>    sub <span class="m">pcb1</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/die.html">die</a> <span class="q">&quot;I&#39;m dying...\n&quot;</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>The mapping between the C callback and the Perl equivalent is stored in
the global variable <code class="inline"><span class="w">callback</span></code>
.</p>
<p>This will be adequate if you ever need to have only one callback
registered at any time. An example could be an error handler like the
code sketched out above. Remember though, repeated calls to
<code class="inline"><span class="w">register_fatal</span></code>
 will replace the previously registered callback
function with the new one.</p>
<p>Say for example you want to interface to a library which allows asynchronous
file i/o.  In this case you may be able to register a callback whenever
a read operation has completed. To be of any use we want to be able to
call separate Perl subroutines for each file that is opened.  As it
stands, the error handler example above would not be adequate as it
allows only a single callback to be defined at any time. What we
require is a means of storing the mapping between the opened file and
the Perl subroutine we want to be called for that file.</p>
<p>Say the i/o library has a function <code class="inline"><span class="w">asynch_read</span></code>
 which associates a C
function <code class="inline"><span class="w">ProcessRead</span></code>
 with a file handle <code class="inline"><span class="w">fh</span></code>
--this assumes that it
has also provided some routine to open the file and so obtain the file
handle.</p>
<pre class="verbatim"><ol><li>    <span class="i">asynch_read</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">ProcessRead</span><span class="s">)</span></li></ol></pre><p>This may expect the C <i>ProcessRead</i> function of this form</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">ProcessRead</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a>	<span class="w">fh</span><span class="sc">;</span></li><li>    <span class="w">char</span> *	<span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>         ...</li><li>    <span class="s">}</span></li></ol></pre><p>To provide a Perl interface to this library we need to be able to map
between the <code class="inline"><span class="w">fh</span></code>
 parameter and the Perl subroutine we want called.  A
hash is a convenient mechanism for storing this mapping.  The code
below shows a possible implementation</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">HV</span> * <span class="w">Mapping</span> = <span class="s">(</span><span class="w">HV</span>*<span class="s">)</span><span class="w">NULL</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">asynch_read</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">callback</span><span class="s">)</span></li><li>        <a class="l_k" href="functions/int.html">int</a>	<span class="w">fh</span></li><li>        <span class="w">SV</span> *	<span class="w">callback</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="q">/* If the hash doesn&#39;t already exist, create it */</span></li><li>        if <span class="s">(</span><span class="w">Mapping</span> == <span class="s">(</span><span class="w">HV</span>*<span class="s">)</span><span class="w">NULL</span><span class="s">)</span></li><li>            <span class="w">Mapping</span> = <span class="i">newHV</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Save the fh -&gt; callback mapping */</span></li><li>        <span class="i">hv_store</span><span class="s">(</span><span class="w">Mapping</span><span class="cm">,</span> <span class="s">(</span><span class="w">char</span>*<span class="s">)</span>&amp;<span class="w">fh</span><span class="cm">,</span> <span class="i">sizeof</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="cm">,</span> <span class="i">newSVsv</span><span class="s">(</span><span class="w">callback</span><span class="s">)</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Register with the C Library */</span></li><li>        <span class="i">asynch_read</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">asynch_read_if</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>and <code class="inline"><span class="w">asynch_read_if</span></code>
 could look like this</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">asynch_read_if</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a>	<span class="w">fh</span><span class="sc">;</span></li><li>    <span class="w">char</span> *	<span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <span class="w">SV</span> ** <span class="w">sv</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Get the callback associated with fh */</span></li><li>        <span class="w">sv</span> =  <span class="i">hv_fetch</span><span class="s">(</span><span class="w">Mapping</span><span class="cm">,</span> <span class="s">(</span><span class="w">char</span>*<span class="s">)</span>&amp;<span class="w">fh</span> <span class="cm">,</span> <span class="i">sizeof</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="cm">,</span> <span class="w">FALSE</span><span class="s">)</span><span class="sc">;</span></li><li>        if <span class="s">(</span><span class="w">sv</span> == <span class="s">(</span><span class="w">SV</span>**<span class="s">)</span><span class="w">NULL</span><span class="s">)</span></li><li>            <span class="i">croak</span><span class="s">(</span><span class="q">&quot;Internal error...\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSVpv</span><span class="s">(</span><span class="w">buffer</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Call the Perl sub */</span></li><li>        <span class="i">call_sv</span><span class="s">(</span><span class="i">*sv</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>For completeness, here is <code class="inline"><span class="w">asynch_close</span></code>
.  This shows how to remove
the entry from the hash <code class="inline"><span class="w">Mapping</span></code>
.</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">asynch_close</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span></li><li>        <a class="l_k" href="functions/int.html">int</a>	<span class="w">fh</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <span class="q">/* Remove the entry from the hash */</span></li><li>        <span class="s">(</span><span class="w">void</span><span class="s">)</span> <span class="i">hv_delete</span><span class="s">(</span><span class="w">Mapping</span><span class="cm">,</span> <span class="s">(</span><span class="w">char</span>*<span class="s">)</span>&amp;<span class="w">fh</span><span class="cm">,</span> <span class="i">sizeof</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Now call the real asynch_close */</span></li><li>        <span class="i">asynch_close</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>So the Perl interface would look like this</p>
<pre class="verbatim"><ol><li><a name="callback1"></a>    sub <span class="m">callback1</span></li><li>    <span class="s">{</span></li><li>        <a class="l_k" href="functions/my.html">my</a><span class="s">(</span><span class="i">$handle</span><span class="cm">,</span> <span class="i">$buffer</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="c"># Register the Perl callback</span></li><li>    <span class="i">asynch_read</span><span class="s">(</span><span class="i">$fh</span><span class="cm">,</span> \<span class="i">&amp;callback1</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="i">asynch_close</span><span class="s">(</span><span class="i">$fh</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>The mapping between the C callback and Perl is stored in the global
hash <code class="inline"><span class="w">Mapping</span></code>
 this time. Using a hash has the distinct advantage that
it allows an unlimited number of callbacks to be registered.</p>
<p>What if the interface provided by the C callback doesn't contain a
parameter which allows the file handle to Perl subroutine mapping?  Say
in the asynchronous i/o package, the callback function gets passed only
the <code class="inline"><span class="w">buffer</span></code>
 parameter like this</p>
<pre class="verbatim"><ol><li>    <span class="w">void</span></li><li>    <span class="i">ProcessRead</span><span class="s">(</span><span class="w">buffer</span><span class="s">)</span></li><li>    <span class="w">char</span> *	<span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        ...</li><li>    <span class="s">}</span></li></ol></pre><p>Without the file handle there is no straightforward way to map from the
C callback to the Perl subroutine.</p>
<p>In this case a possible way around this problem is to predefine a
series of C functions to act as the interface to Perl, thus</p>
<pre class="verbatim"><ol><li>    <span class="c">#define MAX_CB		3</span></li><li>    <span class="c">#define NULL_HANDLE	-1</span></li><li>    <span class="w">typedef</span> <span class="w">void</span> <span class="s">(</span><span class="i">*FnMap</span><span class="s">)</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="w">struct</span> <span class="i">MapStruct</span> <span class="s">{</span></li><li>        <span class="w">FnMap</span>    <span class="w">Function</span><span class="sc">;</span></li><li>        <span class="w">SV</span> *     <span class="w">PerlSub</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a>      <span class="w">Handle</span><span class="sc">;</span></li><li>      <span class="s">}</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span>  <span class="i">fn1</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">static</span> <span class="w">void</span>  <span class="i">fn2</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="w">static</span> <span class="w">void</span>  <span class="i">fn3</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">struct</span> <span class="w">MapStruct</span> <span class="w">Map</span> <span class="s">[</span><span class="w">MAX_CB</span><span class="s">]</span> =</li><li>        <span class="s">{</span></li><li>            <span class="s">{</span> <span class="w">fn1</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">NULL_HANDLE</span> <span class="s">}</span><span class="cm">,</span></li><li>            <span class="s">{</span> <span class="w">fn2</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">NULL_HANDLE</span> <span class="s">}</span><span class="cm">,</span></li><li>            <span class="s">{</span> <span class="w">fn3</span><span class="cm">,</span> <span class="w">NULL</span><span class="cm">,</span> <span class="w">NULL_HANDLE</span> <span class="s">}</span></li><li>        <span class="s">}</span><span class="sc">;</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">Pcb</span><span class="s">(</span><a class="l_k" href="functions/index.html">index</a><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <a class="l_k" href="functions/index.html">index</a><span class="sc">;</span></li><li>    <span class="w">char</span> * <span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSVpv</span><span class="s">(</span><span class="w">buffer</span><span class="cm">,</span> <span class="n">0</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Call the Perl sub */</span></li><li>        <span class="i">call_sv</span><span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span><span class="cm">,</span> <span class="w">G_DISCARD</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">fn1</span><span class="s">(</span><span class="w">buffer</span><span class="s">)</span></li><li>    <span class="w">char</span> * <span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="i">Pcb</span><span class="s">(</span><span class="n">0</span><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">fn2</span><span class="s">(</span><span class="w">buffer</span><span class="s">)</span></li><li>    <span class="w">char</span> * <span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="i">Pcb</span><span class="s">(</span><span class="n">1</span><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">fn3</span><span class="s">(</span><span class="w">buffer</span><span class="s">)</span></li><li>    <span class="w">char</span> * <span class="w">buffer</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="i">Pcb</span><span class="s">(</span><span class="n">2</span><span class="cm">,</span> <span class="w">buffer</span><span class="s">)</span><span class="sc">;</span></li><li>    <span class="s">}</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">array_asynch_read</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">callback</span><span class="s">)</span></li><li>        <a class="l_k" href="functions/int.html">int</a>		<span class="w">fh</span></li><li>        <span class="w">SV</span> *	<span class="w">callback</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <a class="l_k" href="functions/index.html">index</a><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">null_index</span> = <span class="w">MAX_CB</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Find the same handle or an empty entry */</span></li><li>        for <span class="s">(</span><a class="l_k" href="functions/index.html">index</a> = <span class="n">0</span><span class="sc">;</span> <a class="l_k" href="functions/index.html">index</a> &lt; <span class="w">MAX_CB</span><span class="sc">;</span> ++<a class="l_k" href="functions/index.html">index</a><span class="s">)</span></li><li>        <span class="s">{</span></li><li>            if <span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Handle</span> == <span class="w">fh</span><span class="s">)</span></li><li>                <a class="l_k" href="functions/break.html">break</a><span class="sc">;</span></li><li></li><li>            if <span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Handle</span> == <span class="w">NULL_HANDLE</span><span class="s">)</span></li><li>                <span class="w">null_index</span> = <a class="l_k" href="functions/index.html">index</a><span class="sc">;</span></li><li>        <span class="s">}</span></li><li></li><li>        if <span class="s">(</span><a class="l_k" href="functions/index.html">index</a> == <span class="w">MAX_CB</span> &amp;&amp; <span class="w">null_index</span> == <span class="w">MAX_CB</span><span class="s">)</span></li><li>            <span class="w">croak</span> <span class="s">(</span><span class="q">&quot;Too many callback functions registered\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><a class="l_k" href="functions/index.html">index</a> == <span class="w">MAX_CB</span><span class="s">)</span></li><li>            <a class="l_k" href="functions/index.html">index</a> = <span class="w">null_index</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Save the file handle */</span></li><li>        <span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Handle</span> = <span class="w">fh</span><span class="sc">;</span></li><li></li><li>        <span class="q">/* Remember the Perl sub */</span></li><li>        if <span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span> == <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="s">)</span></li><li>            <span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span> = <span class="i">newSVsv</span><span class="s">(</span><span class="w">callback</span><span class="s">)</span><span class="sc">;</span></li><li>        else</li><li>            <span class="i">SvSetSV</span><span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span><span class="cm">,</span> <span class="w">callback</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="i">asynch_read</span><span class="s">(</span><span class="w">fh</span><span class="cm">,</span> <span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Function</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>    <span class="w">void</span></li><li>    <span class="i">array_asynch_close</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span></li><li>        <a class="l_k" href="functions/int.html">int</a>	<span class="w">fh</span></li><li>        <span class="w">CODE</span><span class="co">:</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <a class="l_k" href="functions/index.html">index</a><span class="sc">;</span></li><li></li><li>        <span class="q">/* Find the file handle */</span></li><li>        for <span class="s">(</span><a class="l_k" href="functions/index.html">index</a> = <span class="n">0</span><span class="sc">;</span> <a class="l_k" href="functions/index.html">index</a> &lt; <span class="w">MAX_CB</span><span class="sc">;</span> ++ <a class="l_k" href="functions/index.html">index</a><span class="s">)</span></li><li>            if <span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Handle</span> == <span class="w">fh</span><span class="s">)</span></li><li>                <a class="l_k" href="functions/break.html">break</a><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><a class="l_k" href="functions/index.html">index</a> == <span class="w">MAX_CB</span><span class="s">)</span></li><li>            <span class="w">croak</span> <span class="s">(</span><span class="q">&quot;could not close fh %d\n&quot;</span><span class="cm">,</span> <span class="w">fh</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">Handle</span> = <span class="w">NULL_HANDLE</span><span class="sc">;</span></li><li>        <span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">Map</span><span class="s">[</span><a class="l_k" href="functions/index.html">index</a><span class="s">]</span>.<span class="w">PerlSub</span> = <span class="s">(</span><span class="w">SV</span>*<span class="s">)</span><span class="w">NULL</span><span class="sc">;</span></li><li></li><li>        <span class="i">asynch_close</span><span class="s">(</span><span class="w">fh</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p>In this case the functions <code class="inline"><span class="w">fn1</span></code>
, <code class="inline"><span class="w">fn2</span></code>
, and <code class="inline"><span class="w">fn3</span></code>
 are used to
remember the Perl subroutine to be called. Each of the functions holds
a separate hard-wired index which is used in the function <code class="inline"><span class="w">Pcb</span></code>
 to
access the <code class="inline"><span class="w">Map</span></code>
 array and actually call the Perl subroutine.</p>
<p>There are some obvious disadvantages with this technique.</p>
<p>Firstly, the code is considerably more complex than with the previous
example.</p>
<p>Secondly, there is a hard-wired limit (in this case 3) to the number of
callbacks that can exist simultaneously. The only way to increase the
limit is by modifying the code to add more functions and then
recompiling.  None the less, as long as the number of functions is
chosen with some care, it is still a workable solution and in some
cases is the only one available.</p>
<p>To summarize, here are a number of possible methods for you to consider
for storing the mapping between C and the Perl callback</p>
<dl>
<li><a class='view-title' id="1.-Ignore-the-problem---Allow-only-1-callback"></a><strong>Ignore the problem - Allow only 1 callback</strong>
<p>For a lot of situations, like interfacing to an error handler, this may
be a perfectly adequate solution.</p>
</li>
<li><a class='view-title' id="2.-Create-a-sequence-of-callbacks---hard-wired-limit"></a><strong>Create a sequence of callbacks - hard wired limit</strong>
<p>If it is impossible to tell from the parameters passed back from the C
callback what the context is, then you may need to create a sequence of C
callback interface functions, and store pointers to each in an array.</p>
</li>
<li><a class='view-title' id="3.-Use-a-parameter-to-map-to-the-Perl-callback"></a><strong>Use a parameter to map to the Perl callback</strong>
<p>A hash is an ideal mechanism to store the mapping between C and Perl.</p>
</li>
</dl>
<a class='view-head2' id="Alternate-Stack-Manipulation"></a><h3 class='h3' >Alternate Stack Manipulation</h3>
<p>Although I have made use of only the <code class="inline"><span class="w">POP</span>*</code>
 macros to access values
returned from Perl subroutines, it is also possible to bypass these
macros and read the stack using the <code class="inline"><span class="w">ST</span></code>
 macro (See <a href="perlxs.html">perlxs</a> for a
full description of the <code class="inline"><span class="w">ST</span></code>
 macro).</p>
<p>Most of the time the <code class="inline"><span class="w">POP</span>*</code>
 macros should be adequate; the main
problem with them is that they force you to process the returned values
in sequence. This may not be the most suitable way to process the
values in some cases. What we want is to be able to access the stack in
a random order. The <code class="inline"><span class="w">ST</span></code>
 macro as used when coding an XSUB is ideal
for this purpose.</p>
<p>The code below is the example given in the section <i>Returning a List
of Values</i> recoded to use <code class="inline"><span class="w">ST</span></code>
 instead of <code class="inline"><span class="w">POP</span>*</code>
.</p>
<pre class="verbatim"><ol><li>    <span class="w">static</span> <span class="w">void</span></li><li>    <span class="i">call_AddSubtract2</span><span class="s">(</span><span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="s">)</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">a</span><span class="sc">;</span></li><li>    <a class="l_k" href="functions/int.html">int</a> <span class="w">b</span><span class="sc">;</span></li><li>    <span class="s">{</span></li><li>        <span class="w">dSP</span><span class="sc">;</span></li><li>        <span class="w">I32</span> <span class="w">ax</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/int.html">int</a> <span class="w">count</span><span class="sc">;</span></li><li></li><li>        <span class="w">ENTER</span><span class="sc">;</span></li><li>        <span class="w">SAVETMPS</span><span class="sc">;</span></li><li></li><li>        <span class="i">PUSHMARK</span><span class="s">(</span><span class="w">SP</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">a</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="i">XPUSHs</span><span class="s">(</span><span class="i">sv_2mortal</span><span class="s">(</span><span class="i">newSViv</span><span class="s">(</span><span class="w">b</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li></li><li>        <span class="w">count</span> = <span class="i">call_pv</span><span class="s">(</span><span class="q">&quot;AddSubtract&quot;</span><span class="cm">,</span> <span class="w">G_ARRAY</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li>        <span class="w">SP</span> -= <span class="w">count</span><span class="sc">;</span></li><li>        <span class="w">ax</span> = <span class="s">(</span><span class="w">SP</span> - <span class="w">PL_stack_base</span><span class="s">)</span> + <span class="n">1</span><span class="sc">;</span></li><li></li><li>        if <span class="s">(</span><span class="w">count</span> != <span class="n">2</span><span class="s">)</span></li><li>            <span class="i">croak</span><span class="s">(</span><span class="q">&quot;Big trouble\n&quot;</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d + %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="i">SvIV</span><span class="s">(</span><span class="i">ST</span><span class="s">(</span><span class="n">0</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li>        <a class="l_k" href="functions/printf.html">printf</a> <span class="s">(</span><span class="q">&quot;%d - %d = %d\n&quot;</span><span class="cm">,</span> <span class="w">a</span><span class="cm">,</span> <span class="w">b</span><span class="cm">,</span> <span class="i">SvIV</span><span class="s">(</span><span class="i">ST</span><span class="s">(</span><span class="n">1</span><span class="s">)</span><span class="s">)</span><span class="s">)</span><span class="sc">;</span></li><li></li><li>        <span class="w">PUTBACK</span><span class="sc">;</span></li><li>        <span class="w">FREETMPS</span><span class="sc">;</span></li><li>        <span class="w">LEAVE</span><span class="sc">;</span></li><li>    <span class="s">}</span></li></ol></pre><p>Notes</p>
<dl>
<li>
<p>Notice that it was necessary to define the variable <code class="inline"><span class="w">ax</span></code>
.  This is
because the <code class="inline"><span class="w">ST</span></code>
 macro expects it to exist.  If we were in an XSUB it
would not be necessary to define <code class="inline"><span class="w">ax</span></code>
 as it is already defined for
us.</p>
</li>
<li>
<p>The code</p>
<pre class="verbatim"><ol><li>        <span class="w">SPAGAIN</span><span class="sc">;</span></li><li>        <span class="w">SP</span> -= <span class="w">count</span><span class="sc">;</span></li><li>        <span class="w">ax</span> = <span class="s">(</span><span class="w">SP</span> - <span class="w">PL_stack_base</span><span class="s">)</span> + <span class="n">1</span><span class="sc">;</span></li></ol></pre><p>sets the stack up so that we can use the <code class="inline"><span class="w">ST</span></code>
 macro.</p>
</li>
<li>
<p>Unlike the original coding of this example, the returned
values are not accessed in reverse order.  So <code class="inline"><span class="i">ST</span><span class="s">(</span><span class="n">0</span><span class="s">)</span></code>
 refers to the
first value returned by the Perl subroutine and <code class="inline"><span class="i">ST</span><span class="s">(</span><span class="w">count</span>-<span class="n">1</span><span class="s">)</span></code>

refers to the last.</p>
</li>
</dl>
<a class='view-head2' id="Creating-and-Calling-an-Anonymous-Subroutine-in-C"></a><h3 class='h3' >Creating and Calling an Anonymous Subroutine in C</h3>
<p>As we've already shown, <code class="inline"><span class="w">call_sv</span></code>
 can be used to invoke an
anonymous subroutine.  However, our example showed a Perl script
invoking an XSUB to perform this operation.  Let's see how it can be
done inside our C code:</p>
<pre class="verbatim"><ol><li> ...</li><li></li><li> <span class="w">SV</span> *<span class="w">cvrv</span> = <span class="i">eval_pv</span><span class="s">(</span><span class="q">&quot;sub { print &#39;You will not find me cluttering any namespace!&#39; }&quot;</span><span class="cm">,</span> <span class="w">TRUE</span><span class="s">)</span><span class="sc">;</span></li><li></li><li> ...</li><li></li><li> <span class="i">call_sv</span><span class="s">(</span><span class="w">cvrv</span><span class="cm">,</span> <span class="w">G_VOID</span>|<span class="w">G_NOARGS</span><span class="s">)</span><span class="sc">;</span></li></ol></pre><p><code class="inline"><span class="w">eval_pv</span></code>
 is used to compile the anonymous subroutine, which
will be the return value as well (read more about <code class="inline"><span class="w">eval_pv</span></code>
 in
<a href="perlapi.html#eval_pv">eval_pv in perlapi</a>).  Once this code reference is in hand, it
can be mixed in with all the previous examples we've shown.</p>
<a class='view-head1' id="LIGHTWEIGHT-CALLBACKS"></a><h2 class='h2' >LIGHTWEIGHT CALLBACKS</h2>
<p>Sometimes you need to invoke the same subroutine repeatedly.
This usually happens with a function that acts on a list of
values, such as Perl's built-in sort(). You can pass a
comparison function to sort(), which will then be invoked
for every pair of values that needs to be compared. The first()
and reduce() functions from <a href="List/Util.html">List::Util</a> follow a similar
pattern.</p>
<p>In this case it is possible to speed up the routine (often
quite substantially) by using the lightweight callback API.
The idea is that the calling context only needs to be
created and destroyed once, and the sub can be called
arbitrarily many times in between.</p>
<p>It is usual to pass parameters using global variables (typically
$_ for one parameter, or $a and $b for two parameters) rather
than via @_. (It is possible to use the @_ mechanism if you know
what you're doing, though there is as yet no supported API for
it. It's also inherently slower.)</p>
<p>The pattern of macro calls is like this:</p>
<pre class="verbatim"><ol><li>    <span class="w">dMULTICALL</span><span class="sc">;</span>			<span class="q">/* Declare local variables */</span></li><li>    <span class="w">I32</span> <span class="w">gimme</span> = <span class="w">G_SCALAR</span><span class="sc">;</span>	<span class="q">/* context of the call: G_SCALAR,</span></li><li>				 <span class="q">				 * G_LIST, or G_VOID */</span></li><li></li><li>    <span class="i">PUSH_MULTICALL</span><span class="s">(</span><span class="w">cv</span><span class="s">)</span><span class="sc">;</span>		<span class="q">/* Set up the context for calling cv,</span></li><li>				   <span class="q">				   and set local vars appropriately */</span></li><li></li><li>    /<span class="i">* loop</span> *<span class="q">/ {</span></li><li>        <span class="q">        /</span>* <span class="w">set</span> <span class="w">the</span> <span class="i">value</span><span class="s">(</span><span class="q">s) af your parameter variables */</span></li><li>        <span class="q">        MULTICALL;		/* Make the actual call */</span></li><li>    <span class="q">    } /* end of loop */</span></li><li></li><li>    <span class="q">    POP_MULTICALL;		/* Tear down the calling context */</span></li></ol></pre><p>For some concrete examples, see the implementation of the
first() and reduce() functions of List::Util 1.18. There you
will also find a header file that emulates the multicall API
on older versions of perl.</p>
<a class='view-head1' id="SEE-ALSO"></a><h2 class='h2' >SEE ALSO</h2>
<p><a href="perlxs.html">perlxs</a>, <a href="perlguts.html">perlguts</a>, <a href="perlembed.html">perlembed</a></p>
<a class='view-head1' id="AUTHOR"></a><h2 class='h2' >AUTHOR</h2>
<p>Paul Marquess</p>
<p>Special thanks to the following people who assisted in the creation of
the document.</p>
<p>Jeff Okamoto, Tim Bunce, Nick Gianniotis, Steve Kelem, Gurusamy Sarathy
and Larry Wall.</p>
<a class='view-head1' id="DATE"></a><h2 class='h2' >DATE</h2>
<p>Version 1.3, 14th Apr 1997</p>




      <ul><li><a href="#NAME">NAME</a></li><li><a href="#DESCRIPTION">DESCRIPTION</a></li><li><a href="#THE-CALL_-FUNCTIONS">THE CALL_ FUNCTIONS</a></li><li><a href="#FLAG-VALUES">FLAG VALUES</a></li><ul><li><a href="#G_VOID">G_VOID</a></li><li><a href="#G_SCALAR">G_SCALAR</a></li><li><a href="#G_ARRAY">G_ARRAY</a></li><li><a href="#G_DISCARD">G_DISCARD</a></li><li><a href="#G_NOARGS">G_NOARGS</a></li><li><a href="#G_EVAL">G_EVAL</a></li><li><a href="#G_KEEPERR">G_KEEPERR</a></li><li><a href="#Determining-the-Context">Determining the Context</a></li></ul><li><a href="#EXAMPLES">EXAMPLES</a></li><ul><li><a href="#No-Parameters%2c-Nothing-Returned">No Parameters, Nothing Returned</a></li><li><a href="#Passing-Parameters">Passing Parameters</a></li><li><a href="#Returning-a-Scalar">Returning a Scalar</a></li><li><a href="#Returning-a-List-of-Values">Returning a List of Values</a></li><li><a href="#Returning-a-List-in-a-Scalar-Context">Returning a List in a Scalar Context</a></li><li><a href="#Returning-Data-from-Perl-via-the-Parameter-List">Returning Data from Perl via the Parameter List</a></li><li><a href="#Using-G_EVAL">Using G_EVAL</a></li><li><a href="#Using-G_KEEPERR">Using G_KEEPERR</a></li><li><a href="#Using-call_sv">Using call_sv</a></li><li><a href="#Using-call_argv">Using call_argv</a></li><li><a href="#Using-call_method">Using call_method</a></li><li><a href="#Using-GIMME_V">Using GIMME_V</a></li><li><a href="#Using-Perl-to-Dispose-of-Temporaries">Using Perl to Dispose of Temporaries</a></li><li><a href="#Strategies-for-Storing-Callback-Context-Information">Strategies for Storing Callback Context Information</a></li><li><a href="#Alternate-Stack-Manipulation">Alternate Stack Manipulation</a></li><li><a href="#Creating-and-Calling-an-Anonymous-Subroutine-in-C">Creating and Calling an Anonymous Subroutine in C</a></li></ul><li><a href="#LIGHTWEIGHT-CALLBACKS">LIGHTWEIGHT CALLBACKS</a></li><li><a href="#SEE-ALSO">SEE ALSO</a></li><li><a href="#AUTHOR">AUTHOR</a></li><li><a href="#DATE">DATE</a></li></ul>


                  </div>
                </article>
              </div>
            </div>
          </main>
        </div>
           <footer class="footer row bg-light pt-5 pb-5">
       <div class="col-sm-10 offset-sm-1 col-xl-8 offset-xl-2">
           <div class="row">
               <div class="col-md-4">
                   <ul class="list-unstyled">
                       <li>
                           <h4>Site info</h4>
                       </li>
                       <li>Docs mantained by
                           <a href="//lists.perl.org/list/perl5-porters.html"
                               rel="noopener">Perl 5 Porters</a>
                       </li>
                       <li>Perldoc site development sponsored by
                           <a href="//opusvl.com" rel="noopener">
                           <img style="margin: 20px 20px 5px 10px" class="opus-logo" src="/public/img/opusvl_logo.svg" alt="OpusVL Logo">
                        </a>
                    <li><span class="about_perldoc"><a href="//about.html">About PerlDOC</a></span>
                    </li>
                       </li>
                   </ul>
               </div>
               <div class="col-md-8">
                   <div class="row">
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Manuals</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-overview.html">Overview</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-tutorials.html">Tutorials</a>
                               </li>
                               <li>
                                   <a href="/5.14.3/index-faq.html">FAQs</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-history.html">Changes</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Reference</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-language.html">Language</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-functions.html">Functions</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/perlop.html">Operators</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/perlvar.html">Variables</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Modules</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-modules-A.html">Modules</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-pragmas.html">Pragmas</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-utilities.html">Utilities</a>
                               </li>
                           </ul>
                       </div>
                       <div class="col-md-6 col-lg-3">
                           <ul class=" list-unstyled">
                               <li>
                                   <h4>Misc</h4>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-licence.html">License</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-internals.html">Internals</a>
                               </li>
                               <li>
                                   <a
                                       href="/5.14.3/index-platforms.html">Platforms</a>
                               </li>
                            <li>
                                <a
                                    href="/5.14.3/index-about.html">About</a>
                            </li>
                           </ul>
                       </div>
                   </div>
               </div>
               <div class=" col-12 footer-inf text-center">
                   <small>perldoc.perl.org - Official documentation for the Perl
                       programming language</small>
               </div>
           </div>
       </div>
   </footer>

        	<div class="beta-wrapper beta-bottom-right ">
		<div class="beta beta-blue  ">
			<a class="beta-link "
				href="//github.com/OpusVL/perldoc.perl.org/issues/new" rel="noopener">
				<span class="beta-text">
					This website is a Beta release.
				</span>
				<span class="beta-text">
					For any issues please raise a ticket on GitHub
				</span>
			</a>
		</div>
	</div>

        <script src="/public/js/main.min.js"></script>
      </body>

      </html>
